<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>„Å™„Çè„Å®„Å≥Ê§úÂÆö„Ç´„Éº„Éâ</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google FontsÔºà„ÇÑ„Çè„Çâ„Åã„Åè„Å¶Â≠ê„Å©„ÇÇÂêë„ÅëÔºâ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- Babel for JSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Import Map for module resolution -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
  </script>

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    html, body{
      overflow-x: hidden; /* Ê®™„ÅØ„ÅøÂá∫„ÅóÂØæÁ≠ñ */
    }
    *{
      -webkit-tap-highlight-color: transparent; /* iOS„ÅÆ„Çø„ÉÉ„ÉóÂº∑Ë™øÔºàÁôΩ„Éï„É©„ÉÉ„Ç∑„É•„Å£„ÅΩ„ÅïÔºâÂØæÁ≠ñ */
    }
    body{
      font-family: "M PLUS Rounded 1c", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: calc(96px + var(--safe-bottom));
    }

    /* input type="number" „ÅÆ„Çπ„Éî„É≥„Éú„Çø„É≥„ÇíÊ∂à„Åô */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Sticky column */
    .sticky-col {
      position: sticky;
      left: 0;
      z-index: 10;
      background: white;
      border-right: 2px solid #e2e8f0;
    }
    .sticky-corner {
      position: sticky;
      left: 0;
      top: 0;
      z-index: 30;
      background: #f8fafc;
      border-right: 2px solid #e2e8f0;
      border-bottom: 2px solid #e2e8f0;
    }

    /* Animations */
    @keyframes popIn {
      0% { transform: scale(0.92); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .animate-popIn { animation: popIn 0.28s cubic-bezier(0.175, 0.885, 0.32, 1.2) both; }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeInUp { animation: fadeInUp 0.25s ease-out both; }

    /* Confetti-like background (backup) */
    @keyframes confettiBg {
      0% { background-position: 0 0; }
      100% { background-position: 120px 120px; }
    }
    .bg-confetti {
      background-image:
        radial-gradient(#FCD34D 22%, transparent 22%),
        radial-gradient(#FB7185 22%, transparent 22%),
        radial-gradient(#60A5FA 22%, transparent 22%);
      background-color: #ffffff;
      background-position: 0 0, 60px 30px, 30px 60px;
      background-size: 120px 120px;
      animation: confettiBg 4s linear infinite;
    }
  </style>
</head>

<body class="bg-sky-50 text-slate-800 select-none">
  <div id="root"></div>

  <script type="text/babel" data-type="module" id="app-script">
    import React, { useEffect, useMemo, useRef, useState, useCallback } from "react";
    import { createRoot } from "react-dom/client";
    import {
      Activity, Award, Calendar, CalendarDays, Check, CheckCircle, ChevronDown, ChevronUp,
      Copy, Download, FileDown, Flame, Home, List, Medal, Pencil, RefreshCw,
      RotateCcw, Save, Settings, Sparkles, Star, Target, Trophy, Upload, User, Volume2, VolumeX, X, Trash2,
      ChevronLeft, ChevronRight
    } from "lucide-react";

    // =========================
    // ÂÖàÁîü„É¢„Éº„ÉâÔºàÈÖç‰ªòÁî®„Å´ false „Å´Êõ∏„ÅçÊèõ„Åà„ÇãÔºâ
    // =========================
    const IS_TEACHER_MODE = true;

    // „Éê„Éº„Ç∏„Éß„É≥
    const DATA_VERSION = "2026-v1-ultimate-nawatobi";

    // =========================
    // ÊäÄIDÔºàÂÜÖÈÉ®Âõ∫ÂÆöÔºâ
    // =========================
    const TRICK_IDS = [
      "mae", "ushiro", "kataashi", "kakeashi", "kakeashi_ushiro",
      "nibyoushi", "aya", "aya_ushiro", "kousa", "kousa_ushiro",
      "niju", "aya_niju", "sokushin", "kousa_niju", "niju_ushiro",
      "zengo_kousa", "sanju"
    ];

    // ÊäÄÂêç„Éá„Éï„Ç©„É´„Éà
    const DEFAULT_TRICK_NAMES = {
      low: {
        mae: "„Çä„Çá„ÅÜ„ÅÇ„Åó„Å®„Å≥", ushiro: "„Çä„Çá„ÅÜ„ÅÇ„Åó„Å®„Å≥Ôºà„ÅÜ„Åó„ÇçÔºâ", kataashi: "„Åã„Åü„ÅÇ„Åó„Å®„Å≥", kakeashi: "„Åã„Åë„ÅÇ„Åó„Å®„Å≥", kakeashi_ushiro: "„Åã„Åë„ÅÇ„Åó„Å®„Å≥Ôºà„ÅÜ„Åó„ÇçÔºâ",
        nibyoushi: "Ôºí„Å≥„Çá„ÅÜ„Åó„Å®„Å≥", aya: "„ÅÇ„ÇÑ„Å®„Å≥", aya_ushiro: "„ÅÇ„ÇÑ„Å®„Å≥Ôºà„ÅÜ„Åó„ÇçÔºâ", kousa: "„Åì„ÅÜ„Åï„Å®„Å≥", kousa_ushiro: "„Åì„ÅÜ„Åï„Å®„Å≥Ôºà„ÅÜ„Åó„ÇçÔºâ",
        niju: "Ôºí„Åò„ÇÖ„ÅÜ„Å®„Å≥", aya_niju: "„ÅÇ„ÇÑÔºí„Åò„ÇÖ„ÅÜ„Å®„Å≥", sokushin: "„Åù„Åè„Åó„Çì„Å®„Å≥", kousa_niju: "„Åì„ÅÜ„ÅïÔºí„Åò„ÇÖ„ÅÜ„Å®„Å≥", niju_ushiro: "Ôºí„Åò„ÇÖ„ÅÜ„Å®„Å≥Ôºà„ÅÜ„Åó„ÇçÔºâ",
        zengo_kousa: "„Åú„Çì„Åî„Åì„ÅÜ„Åï„Å®„Å≥", sanju: "Ôºì„Åò„ÇÖ„ÅÜ„Å®„Å≥"
      },
      mid: {
        mae: "„Çä„Çá„ÅÜË∂≥„Å®„Å≥", ushiro: "„Çä„Çá„ÅÜË∂≥„Å®„Å≥ÔºàÂæå„ÇçÔºâ", kataashi: "„Åã„ÅüË∂≥„Å®„Å≥", kakeashi: "„Åã„ÅëË∂≥„Å®„Å≥", kakeashi_ushiro: "„Åã„ÅëË∂≥„Å®„Å≥ÔºàÂæå„ÇçÔºâ",
        nibyoushi: "Ôºí„Å≥„Çá„ÅÜ„Åó„Å®„Å≥", aya: "„ÅÇ„ÇÑ„Å®„Å≥", aya_ushiro: "„ÅÇ„ÇÑ„Å®„Å≥ÔºàÂæå„ÇçÔºâ", kousa: "‰∫§„Åï„Å®„Å≥", kousa_ushiro: "‰∫§„Åï„Å®„Å≥ÔºàÂæå„ÇçÔºâ",
        niju: "Ôºí„Åò„ÇÖ„ÅÜ„Å®„Å≥", aya_niju: "„ÅÇ„ÇÑÔºí„Åò„ÇÖ„ÅÜ„Å®„Å≥", sokushin: "ÂÅ¥ÊåØ„Å®„Å≥", kousa_niju: "‰∫§„ÅïÔºí„Åò„ÇÖ„ÅÜ„Å®„Å≥", niju_ushiro: "Ôºí„Åò„ÇÖ„ÅÜ„Å®„Å≥ÔºàÂæå„ÇçÔºâ",
        zengo_kousa: "ÂâçÂæå‰∫§„Åï„Å®„Å≥", sanju: "Ôºì„Åò„ÇÖ„ÅÜ„Å®„Å≥"
      },
      high: {
        mae: "‰∏°Ë∂≥„Å®„Å≥", ushiro: "‰∏°Ë∂≥„Å®„Å≥ÔºàÂæå„ÇçÔºâ", kataashi: "ÁâáË∂≥„Å®„Å≥", kakeashi: "„Åã„ÅëË∂≥„Å®„Å≥", kakeashi_ushiro: "„Åã„ÅëË∂≥„Å®„Å≥ÔºàÂæå„ÇçÔºâ",
        nibyoushi: "Ôºí„Å≥„Çá„ÅÜ„Åó„Å®„Å≥", aya: "„ÅÇ„ÇÑ„Å®„Å≥", aya_ushiro: "„ÅÇ„ÇÑ„Å®„Å≥ÔºàÂæå„ÇçÔºâ", kousa: "‰∫§Â∑Æ„Å®„Å≥", kousa_ushiro: "‰∫§Â∑Æ„Å®„Å≥ÔºàÂæå„ÇçÔºâ",
        niju: "ÔºíÈáç„Å®„Å≥", aya_niju: "„ÅÇ„ÇÑÔºíÈáç„Å®„Å≥", sokushin: "ÂÅ¥„Åó„Çì„Å®„Å≥", kousa_niju: "‰∫§Â∑ÆÔºíÈáç„Å®„Å≥", niju_ushiro: "ÔºíÈáç„Å®„Å≥„ÅÜ„Åó„Çç",
        zengo_kousa: "ÂâçÂæå‰∫§Â∑Æ„Å®„Å≥", sanju: "ÔºìÈáç„Å®„Å≥"
      }
    };

    // ÊäÄ„ÅÆËâ≤ÔºàÂõ∫ÂÆöÔºâ
    const TRICK_COLORS = {
      mae: "bg-blue-100 text-blue-600 border-blue-200",
      ushiro: "bg-indigo-100 text-indigo-600 border-indigo-200",
      kataashi: "bg-teal-100 text-teal-600 border-teal-200",
      kakeashi: "bg-green-100 text-green-600 border-green-200",
      kakeashi_ushiro: "bg-emerald-100 text-emerald-600 border-emerald-200",
      nibyoushi: "bg-cyan-100 text-cyan-600 border-cyan-200",
      aya: "bg-yellow-100 text-yellow-700 border-yellow-200",
      aya_ushiro: "bg-amber-100 text-amber-700 border-amber-200",
      kousa: "bg-orange-100 text-orange-600 border-orange-200",
      kousa_ushiro: "bg-red-100 text-red-600 border-red-200",
      niju: "bg-pink-100 text-pink-600 border-pink-200",
      aya_niju: "bg-purple-100 text-purple-600 border-purple-200",
      sokushin: "bg-lime-100 text-lime-600 border-lime-200",
      kousa_niju: "bg-rose-100 text-rose-600 border-rose-200",
      niju_ushiro: "bg-fuchsia-100 text-fuchsia-600 border-fuchsia-200",
      zengo_kousa: "bg-violet-100 text-violet-600 border-violet-200",
      sanju: "bg-slate-100 text-slate-600 border-slate-200"
    };

    // =========================
    // „Éá„Éï„Ç©„É´„ÉàÁ¥öÂà§ÂÆö„Éá„Éº„ÇøÔºàÁèæ„Ç≥„Éº„Éâ„ÅÆ„Åæ„ÅæÔºâ
    // =========================
    const DEFAULT_LEVELS_DATA = {
      low: [
        { level: 20, reqs: { mae: 1, kataashi: 1 } },
        { level: 19, reqs: { mae: 5, kataashi: 4 } },
        { level: 18, reqs: { mae: 10, ushiro: 1, kataashi: 8, kakeashi: 2 } },
        { level: 17, reqs: { mae: 15, ushiro: 3, kataashi: 12, kakeashi: 8 } },
        { level: 16, reqs: { mae: 20, ushiro: 5, kataashi: 16, kakeashi: 16 } },
        { level: 15, reqs: { mae: 25, ushiro: 7, kataashi: 20, kakeashi: 24 } },
        { level: 14, reqs: { mae: 30, ushiro: 10, kakeashi: 30, kakeashi_ushiro: 2, nibyoushi: 4 } },
        { level: 13, reqs: { mae: 35, ushiro: 12, kakeashi: 35, kakeashi_ushiro: 4, nibyoushi: 8 } },
        { level: 12, reqs: { mae: 40, ushiro: 15, kakeashi: 40, kakeashi_ushiro: 8, nibyoushi: 12 } },
        { level: 11, reqs: { mae: 45, ushiro: 20, kakeashi: 45, kakeashi_ushiro: 12, nibyoushi: 16 } },
        { level: 10, reqs: { mae: 50, ushiro: 25, kakeashi: 50, kakeashi_ushiro: 16, nibyoushi: 20 } },
        { level: 9, reqs: { mae: 55, ushiro: 30, kakeashi: 55, kakeashi_ushiro: 20, nibyoushi: 24 } },
        { level: 8, reqs: { mae: 60, ushiro: 35, kakeashi: 60, kakeashi_ushiro: 24, nibyoushi: 28 } },
        { level: 7, reqs: { mae: 65, ushiro: 40, kakeashi: 65, kousa: 1, niju: 1, aya: 2 } },
        { level: 6, reqs: { mae: 70, ushiro: 45, kakeashi: 70, kousa: 2, niju: 2, aya: 4 } },
        { level: 5, reqs: { mae: 75, ushiro: 50, kakeashi: 75, kousa: 3, niju: 3, aya: 6 } },
        { level: 4, reqs: { mae: 80, ushiro: 55, kakeashi: 80, kousa: 4, niju: 4, aya: 8 } },
        { level: 3, reqs: { mae: 85, ushiro: 60, kakeashi: 85, kousa: 6, niju: 5, aya: 12 } },
        { level: 2, reqs: { mae: 90, ushiro: 65, kakeashi: 90, kousa: 8, niju: 6, aya: 16 } },
        { level: 1, reqs: { mae: 100, ushiro: 70, kakeashi: 100, kousa: 10, niju: 7, aya: 24 } }
      ],
      mid: [
        { level: 20, reqs: { mae: 2, nibyoushi: 4 } },
        { level: 19, reqs: { mae: 7, nibyoushi: 8 } },
        { level: 18, reqs: { mae: 10, ushiro: 1, nibyoushi: 12, kakeashi: 4 } },
        { level: 17, reqs: { mae: 15, ushiro: 3, nibyoushi: 16, kakeashi: 10 } },
        { level: 16, reqs: { mae: 20, ushiro: 5, nibyoushi: 20, kakeashi: 20 } },
        { level: 15, reqs: { mae: 30, ushiro: 10, nibyoushi: 40, kakeashi: 30 } },
        { level: 14, reqs: { mae: 40, ushiro: 20, kakeashi: 40, kakeashi_ushiro: 2, aya: 2 } },
        { level: 13, reqs: { mae: 50, ushiro: 30, kakeashi: 50, kakeashi_ushiro: 8, aya: 4 } },
        { level: 12, reqs: { mae: 60, ushiro: 40, kakeashi: 60, kakeashi_ushiro: 12, aya: 6 } },
        { level: 11, reqs: { mae: 70, ushiro: 50, kakeashi: 70, kakeashi_ushiro: 16, aya: 8 } },
        { level: 10, reqs: { mae: 80, ushiro: 60, kakeashi: 80, kakeashi_ushiro: 20, aya: 10 } },
        { level: 9, reqs: { mae: 90, ushiro: 80, kakeashi: 90, kakeashi_ushiro: 24, aya: 12 } },
        { level: 8, reqs: { mae: 100, ushiro: 100, kakeashi: 100, kakeashi_ushiro: 28, aya: 14 } },
        { level: 7, reqs: { mae: 110, ushiro: 110, kousa: 1, kousa_ushiro: 1, niju: 1, aya_ushiro: 2, aya_niju: 1 } },
        { level: 6, reqs: { mae: 120, ushiro: 120, kousa: 5, kousa_ushiro: 3, niju: 2, aya_ushiro: 4, aya_niju: 2 } },
        { level: 5, reqs: { mae: 130, ushiro: 130, kousa: 10, kousa_ushiro: 5, niju: 5, aya_ushiro: 6, aya_niju: 3 } },
        { level: 4, reqs: { mae: 140, ushiro: 140, kousa: 15, kousa_ushiro: 8, niju: 8, aya_ushiro: 8, aya_niju: 4 } },
        { level: 3, reqs: { mae: 160, ushiro: 160, kousa: 20, kousa_ushiro: 10, niju: 10, aya_ushiro: 10, aya_niju: 6 } },
        { level: 2, reqs: { mae: 180, ushiro: 180, kousa: 25, kousa_ushiro: 15, niju: 12, aya_ushiro: 12, aya_niju: 8 } },
        { level: 1, reqs: { mae: 200, ushiro: 200, kousa_ushiro: 30, niju: 20, aya_niju: 20, kousa_niju: 3, niju_ushiro: 7, sanju: 3 } }
      ],
      high: [
        { level: 20, reqs: { mae: 3, nibyoushi: 4, kakeashi: 3 } },
        { level: 19, reqs: { mae: 8, nibyoushi: 8, kakeashi: 8 } },
        { level: 18, reqs: { mae: 15, ushiro: 3, nibyoushi: 12, kakeashi: 15, aya: 2 } },
        { level: 17, reqs: { mae: 20, ushiro: 8, nibyoushi: 20, kakeashi: 20, aya: 4 } },
        { level: 16, reqs: { mae: 30, ushiro: 15, nibyoushi: 40, kakeashi: 30, aya: 8 } },
        { level: 15, reqs: { mae: 40, ushiro: 20, nibyoushi: 60, kakeashi: 40, aya: 14 } },
        { level: 14, reqs: { mae: 50, ushiro: 30, kakeashi: 50, kakeashi_ushiro: 10, aya: 20, kousa: 1, niju: 2, aya_ushiro: 2 } },
        { level: 13, reqs: { mae: 60, ushiro: 40, kakeashi: 60, kakeashi_ushiro: 20, aya: 25, kousa: 5, niju: 4, aya_ushiro: 4 } },
        { level: 12, reqs: { mae: 70, ushiro: 50, kakeashi: 70, kakeashi_ushiro: 30, aya: 30, kousa: 10, niju: 8, aya_ushiro: 8 } },
        { level: 11, reqs: { mae: 80, ushiro: 60, kakeashi: 80, kakeashi_ushiro: 40, aya: 35, kousa: 15, niju: 12, aya_ushiro: 12 } },
        { level: 10, reqs: { mae: 90, ushiro: 70, kakeashi: 90, kakeashi_ushiro: 60, aya: 40, kousa: 20, kousa_ushiro: 1, niju: 16, aya_ushiro: 16 } },
        { level: 9, reqs: { mae: 100, ushiro: 80, kakeashi: 100, kakeashi_ushiro: 80, aya: 45, kousa: 25, kousa_ushiro: 3, niju: 20, aya_ushiro: 20 } },
        { level: 8, reqs: { mae: 120, ushiro: 100, kakeashi: 120, kakeashi_ushiro: 100, aya: 50, kousa: 30, kousa_ushiro: 5, niju: 24, aya_ushiro: 24 } },
        { level: 7, reqs: { mae: 140, ushiro: 110, kousa_ushiro: 3, niju: 8, aya_niju: 1, sokushin: 4, niju_ushiro: 1, zengo_kousa: 1 } },
        { level: 6, reqs: { mae: 150, ushiro: 120, kousa_ushiro: 5, niju: 10, aya_niju: 3, sokushin: 8, niju_ushiro: 2, zengo_kousa: 5 } },
        { level: 5, reqs: { mae: 160, ushiro: 130, kousa_ushiro: 8, niju: 12, aya_niju: 5, sokushin: 12, niju_ushiro: 3, zengo_kousa: 10 } },
        { level: 4, reqs: { mae: 170, ushiro: 140, kousa_ushiro: 10, niju: 14, aya_niju: 8, sokushin: 24, niju_ushiro: 4, zengo_kousa: 20 } },
        { level: 3, reqs: { mae: 180, ushiro: 160, kousa_ushiro: 15, niju: 16, aya_niju: 10, kousa_niju: 1, niju_ushiro: 5, sanju: 1 } },
        { level: 2, reqs: { mae: 190, ushiro: 180, kousa_ushiro: 20, niju: 18, aya_niju: 15, kousa_niju: 2, niju_ushiro: 6, sanju: 2 } },
        { level: 1, reqs: { mae: 200, ushiro: 200, kousa_ushiro: 30, niju: 20, aya_niju: 20, kousa_niju: 3, niju_ushiro: 7, sanju: 3 } }
      ]
    };

    // =========================
    // Êó•‰ªò„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Ôºà„É≠„Éº„Ç´„É´Êó•‰ªò„ÅßÁ¢∫ÂÆü„Å´Ôºâ
    // =========================
    function pad2(n){ return String(n).padStart(2,"0"); }
    function toLocalKey(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function todayKeyLocal(){
      return toLocalKey(new Date());
    }
    function utcKey(d){
      return d.toISOString().split("T")[0];
    }
    function dateFromKey(key){
      const [y,m,d] = (key||"").split("-").map(n=>parseInt(n,10));
      if(!y||!m||!d) return new Date();
      return new Date(y, m-1, d);
    }

    // ÂÖ®ËßíÊï∞Â≠ó‚ÜíÂçäËßí
    function normalizeDigits(str){
      return String(str ?? "")
        .replace(/[Ôºê-Ôºô]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
        .replace(/[^\d]/g, "");
    }

    // =========================
    // Á•ùÊó•Âà§ÂÆöÔºàÁèæ„Ç≥„Éº„Éâ„ÅÆÁ∞°ÊòìÁâàÔºâ
    // =========================
    function isJapaneseHoliday(date) {
      const y = date.getFullYear();
      const m = date.getMonth() + 1;
      const d = date.getDate();
      const w = date.getDay();

      if (m === 1 && d === 1) return true;
      if (m === 2 && d === 11) return true;
      if (m === 2 && d === 23) return true;
      if (m === 3 && d === Math.floor(20.8431 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4))) return true;
      if (m === 4 && d === 29) return true;
      if (m === 5 && d === 3) return true;
      if (m === 5 && d === 4) return true;
      if (m === 5 && d === 5) return true;
      if (m === 8 && d === 11) return true;
      if (m === 9 && d === Math.floor(23.2488 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4))) return true;
      if (m === 11 && d === 3) return true;
      if (m === 11 && d === 23) return true;

      const isNthMonday = (n) => (w === 1 && Math.floor((d - 1) / 7) === (n - 1));
      if (m === 1 && isNthMonday(2)) return true;
      if (m === 7 && isNthMonday(3)) return true;
      if (m === 9 && isNthMonday(3)) return true;
      if (m === 10 && isNthMonday(2)) return true;

      if (w === 1) {
        const yesterday = new Date(date);
        yesterday.setDate(d - 1);
        if (isJapaneseHoliday(yesterday)) return true;
      }
      return false;
    }

    // =========================
    // SoundÔºàÊóß„Ç≥„Éº„Éâ„ÅÆ„ÄåÊ∞óÊåÅ„Å°„Çà„Åï„Äç„ÇíÁßªÊ§çÔºâ
    // =========================
    function createSound(){
      let audioCtx = null;
      const ensure = () => {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === "suspended") audioCtx.resume();
        return audioCtx;
      };
      const tone = (freq, type, duration, gainVal=0.08) => {
        const ctx = ensure();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(gainVal, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0008, ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + duration);
      };
      return {
        click: () => tone(650, "sine", 0.08, 0.06),
        success: () => { tone(900, "triangle", 0.10, 0.07); setTimeout(()=>tone(1200,"triangle",0.18,0.07), 90); },
        fanfare: () => {
          const notes = [523.25, 659.25, 783.99, 1046.5];
          notes.forEach((f, i)=> setTimeout(()=>tone(f,"triangle",0.5,0.07), i*130));
        }
      };
    }

    // =========================
    // Confetti CanvasÔºàÊóß„Ç≥„Éº„Éâ„ÅÆÁ¥ôÂêπÈõ™„ÇíÁßªÊ§çÔºâ
    // =========================
    function useConfetti(){
      const canvasRef = useRef(null);
      const rafRef = useRef(null);
      const particlesRef = useRef([]);
      const runningRef = useRef(false);

      const resize = useCallback(() => {
        const c = canvasRef.current;
        if (!c) return;
        const dpr = window.devicePixelRatio || 1;
        c.width  = Math.floor(window.innerWidth * dpr);
        c.height = Math.floor(window.innerHeight * dpr);
        c.style.width = "100%";
        c.style.height = "100%";
        const ctx = c.getContext("2d");
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }, []);

      useEffect(() => {
        resize();
        window.addEventListener("resize", resize);
        return () => window.removeEventListener("resize", resize);
      }, [resize]);

      const start = useCallback(() => {
        const c = canvasRef.current;
        if (!c) return;
        const ctx = c.getContext("2d");
        const colors = ["#FF6B6B", "#4ECDC4", "#FFE66D", "#FF9F43", "#54A0FF", "#A78BFA"];
        const W = window.innerWidth;
        const H = window.innerHeight;

        particlesRef.current = Array.from({length: 120}).map(() => ({
          x: W/2,
          y: H/2,
          vx: (Math.random()-0.5)*10,
          vy: (Math.random()-0.5)*10 - 6,
          s: Math.random()*7 + 4,
          r: Math.random()*360,
          dr:(Math.random()-0.5)*10,
          col: colors[Math.floor(Math.random()*colors.length)]
        }));

        const startTime = performance.now();
        runningRef.current = true;

        const tick = (t) => {
          if (!runningRef.current) return;
          ctx.clearRect(0,0,W,H);

          const elapsed = t - startTime;
          particlesRef.current.forEach((p) => {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.18;
            p.r += p.dr;

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate((p.r*Math.PI)/180);
            ctx.fillStyle = p.col;
            ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s);
            ctx.restore();
          });

          particlesRef.current = particlesRef.current.filter(p => p.y < H + 40);

          if (elapsed > 2200 || particlesRef.current.length === 0){
            runningRef.current = false;
            ctx.clearRect(0,0,W,H);
            return;
          }
          rafRef.current = requestAnimationFrame(tick);
        };

        if (rafRef.current) cancelAnimationFrame(rafRef.current);
        rafRef.current = requestAnimationFrame(tick);
      }, []);

      const stop = useCallback(() => {
        runningRef.current = false;
        if (rafRef.current) cancelAnimationFrame(rafRef.current);
        const c = canvasRef.current;
        if (!c) return;
        const ctx = c.getContext("2d");
        ctx.clearRect(0,0,window.innerWidth, window.innerHeight);
      }, []);

      return { canvasRef, start, stop };
    }

    // =========================
    // Stable UI componentsÔºà‚Äª„ÉÅ„Ç´„ÉÅ„Ç´Èò≤Ê≠¢„ÅÆ„Åü„ÇÅ AppÂ§ñ„Å∏Ôºâ
    // =========================
    function NavButton({label, icon: Icon, active, onClick, badge}) {
      return (
        <button
          type="button"
          onClick={onClick}
          className={`flex-1 flex flex-col items-center justify-center gap-1 py-2 rounded-2xl transition active:scale-95 ${
            active ? "text-orange-600" : "text-slate-400 hover:text-slate-600"
          }`}
        >
          <div className={`w-12 h-9 rounded-full flex items-center justify-center transition-all ${
            active ? "bg-orange-100 -translate-y-0.5" : "bg-slate-100"
          }`}>
            <Icon size={22} />
          </div>
          <div className="text-[11px] font-extrabold leading-none">{label}</div>
          {badge ? <div className="text-[10px] font-black text-orange-500">{badge}</div> : null}
        </button>
      );
    }

    function ModalShell({open, onClose, playClick, children}) {
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-[9999] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
          <div className="relative w-full max-w-lg animate-popIn">
            <button
              type="button"
              onClick={()=>{ playClick?.(); onClose?.(); }}
              className="absolute -top-2 -right-2 w-10 h-10 rounded-full bg-white text-slate-500 hover:text-slate-700 shadow flex items-center justify-center"
              aria-label="Èñâ„Åò„Çã"
            >
              <X/>
            </button>
            {children}
          </div>
        </div>
      );
    }

    function CalendarMoveModal({open, fromKey, initialKey, onClose, onConfirm, playClick}) {
      const [viewYear, setViewYear] = useState(new Date().getFullYear());
      const [viewMonth, setViewMonth] = useState(new Date().getMonth());
      const [selectedKey, setSelectedKey] = useState(todayKeyLocal());

      useEffect(() => {
        if (!open) return;
        const baseKey = initialKey || todayKeyLocal();
        const d = dateFromKey(baseKey);
        setViewYear(d.getFullYear());
        setViewMonth(d.getMonth());
        setSelectedKey(baseKey);
      }, [open, initialKey]);

      const monthTitle = `${viewYear}Âπ¥ ${viewMonth+1}Êúà`;

      const grid = useMemo(() => {
        const first = new Date(viewYear, viewMonth, 1);
        const last = new Date(viewYear, viewMonth+1, 0);
        const startDow = first.getDay(); // 0..6
        const daysInMonth = last.getDate();
        const cells = [];

        for (let i=0;i<startDow;i++) cells.push(null);
        for (let day=1; day<=daysInMonth; day++){
          cells.push(new Date(viewYear, viewMonth, day));
        }
        while(cells.length % 7 !== 0) cells.push(null);
        return cells;
      }, [viewYear, viewMonth]);

      const moveMonth = (delta) => {
        const d = new Date(viewYear, viewMonth + delta, 1);
        setViewYear(d.getFullYear());
        setViewMonth(d.getMonth());
      };

      const isHoliday = (d) => d && isJapaneseHoliday(d);

      return (
        <ModalShell open={open} onClose={onClose} playClick={playClick}>
          <div className="bg-white rounded-3xl p-6 border-4 border-emerald-200 shadow-2xl">
            <div className="text-center">
              <div className="text-lg font-black text-emerald-700">üìÖ Êó•‰ªò„ÇíÂ§âÊõ¥</div>
              <div className="text-xs font-bold text-slate-500 mt-1">
                {fromKey ? <>ÂØæË±°Ôºö<span className="font-black text-slate-700">{fromKey}</span></> : null}
              </div>
            </div>

            <div className="mt-4 flex items-center justify-between">
              <button
                type="button"
                onClick={()=>{ playClick?.(); moveMonth(-1); }}
                className="w-10 h-10 rounded-2xl bg-slate-100 hover:bg-slate-200 border border-slate-200 flex items-center justify-center active:scale-95"
                aria-label="Ââç„ÅÆÊúà"
              >
                <ChevronLeft/>
              </button>
              <div className="font-black text-slate-700">{monthTitle}</div>
              <button
                type="button"
                onClick={()=>{ playClick?.(); moveMonth(1); }}
                className="w-10 h-10 rounded-2xl bg-slate-100 hover:bg-slate-200 border border-slate-200 flex items-center justify-center active:scale-95"
                aria-label="Ê¨°„ÅÆÊúà"
              >
                <ChevronRight/>
              </button>
            </div>

            <div className="mt-3 grid grid-cols-7 gap-2 text-center text-xs font-black">
              {["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"].map((w,i)=>(
                <div key={w} className={`${i===0?"text-red-500":i===6?"text-blue-500":"text-slate-400"}`}>{w}</div>
              ))}
            </div>

            <div className="mt-2 grid grid-cols-7 gap-2">
              {grid.map((d, idx) => {
                if(!d) return <div key={idx} className="h-10"></div>;
                const k = toLocalKey(d);
                const isSel = (k === selectedKey);
                const isToday = (k === todayKeyLocal());
                const red = isHoliday(d) || d.getDay()===0;
                const blue = d.getDay()===6;

                return (
                  <button
                    type="button"
                    key={idx}
                    onClick={()=>{ playClick?.(); setSelectedKey(k); }}
                    className={`h-10 rounded-2xl border text-sm font-black flex items-center justify-center active:scale-95 transition ${
                      isSel
                        ? "bg-emerald-500 text-white border-emerald-500 shadow"
                        : "bg-white border-slate-200 hover:bg-slate-50"
                    } ${isToday && !isSel ? "ring-2 ring-offset-1 ring-sky-300" : ""}`}
                    title={k}
                  >
                    <span className={`${!isSel ? (red ? "text-red-500" : blue ? "text-blue-500" : "text-slate-700") : ""}`}>
                      {d.getDate()}
                    </span>
                  </button>
                );
              })}
            </div>

            <div className="mt-4 flex gap-2">
              <button
                type="button"
                onClick={()=>{ playClick?.(); setSelectedKey(todayKeyLocal()); const t=new Date(); setViewYear(t.getFullYear()); setViewMonth(t.getMonth()); }}
                className="px-3 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 border border-slate-200 font-black text-xs active:scale-95"
              >
                ‰ªäÊó•„Å∏
              </button>
              <div className="flex-1"></div>
              <button
                type="button"
                onClick={()=>{ playClick?.(); onClose?.(); }}
                className="px-4 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-black active:scale-95"
              >
                „Ç≠„É£„É≥„Çª„É´
              </button>
              <button
                type="button"
                onClick={()=>{ playClick?.(); onConfirm?.(selectedKey); }}
                className="px-4 py-3 rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white font-black shadow active:scale-95"
              >
                Â§âÊõ¥
              </button>
            </div>

            <div className="mt-3 text-center text-[11px] font-bold text-slate-400">
              ÈÅ∏ÊäûÔºö<span className="text-slate-700 font-black">{selectedKey}</span>
            </div>
          </div>
        </ModalShell>
      );
    }

    // =========================
    // Main App
    // =========================
    function App(){
      // ---------- Core states ----------
      const [user, setUser] = useState({ grade: 1, classVal: "", number: "", name: "", isRegistered: true });

      const [records, setRecords] = useState({});
      const [dailyRecords, setDailyRecords] = useState({});
      const [maxRecords, setMaxRecords] = useState({});
      const [history, setHistory] = useState({});

      const [activeTab, setActiveTab] = useState("home");
      const [historyView, setHistoryView] = useState("calendar");

      const [targetDate, setTargetDate] = useState(todayKeyLocal());

      // customization
      const [levelsData, setLevelsData] = useState(DEFAULT_LEVELS_DATA);
      const [trickNames, setTrickNames] = useState(DEFAULT_TRICK_NAMES);
      const [settingTab, setSettingTab] = useState("low");

      // goals + achievements + import/export modal
      const [goals, setGoals] = useState({});
      const [goalDraft, setGoalDraft] = useState({}); // ‚òÖÂÖ•ÂäõÈÄî‰∏≠„Çí„Åì„Åì„Å´‰øùÊåÅÔºà„ÉÅ„Ç´„ÉÅ„Ç´/ÂãùÊâã„Å´ÈÅîÊàê„ÇíÈò≤Ê≠¢Ôºâ
      const [goalAchievements, setGoalAchievements] = useState([]);
      const [goalModalOpen, setGoalModalOpen] = useState(false);
      const [goalUpdateModal, setGoalUpdateModal] = useState(null);
      const [importModalOpen, setImportModalOpen] = useState(false);
      const [importText, setImportText] = useState("");
      const [deleteModal, setDeleteModal] = useState(null);

      const [copyToast, setCopyToast] = useState(false);

      // calendar move modal (history table)
      const [dateMoveModal, setDateMoveModal] = useState(null); // {fromKey}

      // sound toggle
      const [soundEnabled, setSoundEnabled] = useState(true);
      const soundRef = useRef(null);

      // confetti
      const confetti = useConfetti();

      // ---------- Storage Keys ----------
      const LS = {
        user: "nawatobi_user",
        records: "nawatobi_records",
        daily: "nawatobi_daily_records",
        max: "nawatobi_max_records",
        hist: "nawatobi_history",
        levels: "nawatobi_levels",
        names: "nawatobi_trick_names",
        ver: "nawatobi_version",
        goals: "nawatobi_goals",
        goalAch: "nawatobi_goal_achievements",
        sound: "nawatobi_sound_enabled"
      };

      // ---------- Init ----------
      useEffect(() => {
        soundRef.current = createSound();

        const savedUser = localStorage.getItem(LS.user);
        const savedDaily = localStorage.getItem(LS.daily);
        const savedMax = localStorage.getItem(LS.max);
        const savedHistory = localStorage.getItem(LS.hist);
        const savedLevels = localStorage.getItem(LS.levels);
        const savedNames = localStorage.getItem(LS.names);
        const savedVersion = localStorage.getItem(LS.ver);

        const savedGoals = localStorage.getItem(LS.goals);
        const savedGoalAch = localStorage.getItem(LS.goalAch);
        const savedSound = localStorage.getItem(LS.sound);

        if (savedUser){
          try{ setUser(prev => ({...prev, ...JSON.parse(savedUser), isRegistered:true})); }catch(e){}
        }

        let initialDaily = {};
        if (savedDaily){
          try{ initialDaily = JSON.parse(savedDaily); setDailyRecords(initialDaily); }catch(e){}
        }

        if (savedHistory){
          try{ setHistory(JSON.parse(savedHistory)); }catch(e){}
        }

        if (savedMax){
          try{ setMaxRecords(JSON.parse(savedMax)); }catch(e){}
        } else {
          const compat = localStorage.getItem(LS.records);
          if (compat){
            try{
              const old = JSON.parse(compat);
              setMaxRecords(old);
              localStorage.setItem(LS.max, JSON.stringify(old));
            }catch(e){}
          }
        }

        const isOldVersion = savedVersion !== DATA_VERSION;
        if (isOldVersion){
          setLevelsData(DEFAULT_LEVELS_DATA);
          setTrickNames(DEFAULT_TRICK_NAMES);
          localStorage.setItem(LS.levels, JSON.stringify(DEFAULT_LEVELS_DATA));
          localStorage.setItem(LS.names, JSON.stringify(DEFAULT_TRICK_NAMES));
          localStorage.setItem(LS.ver, DATA_VERSION);
        } else {
          if (savedLevels){
            try{ setLevelsData(JSON.parse(savedLevels)); }catch(e){}
          }
          if (savedNames){
            try{ setTrickNames(JSON.parse(savedNames)); }catch(e){}
          }
        }

        if (savedGoals){
          try{ setGoals(JSON.parse(savedGoals)); }catch(e){}
        }
        if (savedGoalAch){
          try{ setGoalAchievements(JSON.parse(savedGoalAch)); }catch(e){}
        }
        if (savedSound !== null){
          setSoundEnabled(savedSound === "true");
        } else {
          setSoundEnabled(true);
        }

        const todayLocal = todayKeyLocal();
        const todayUTC = utcKey(new Date());
        if (initialDaily && initialDaily[todayUTC] && !initialDaily[todayLocal]){
          const migrated = {...initialDaily, [todayLocal]: initialDaily[todayUTC]};
          delete migrated[todayUTC];
          setDailyRecords(migrated);
          localStorage.setItem(LS.daily, JSON.stringify(migrated));

          const h = savedHistory ? (JSON.parse(savedHistory) || {}) : {};
          if (h[todayUTC] && !h[todayLocal]){
            const mh = {...h, [todayLocal]: true};
            delete mh[todayUTC];
            setHistory(mh);
            localStorage.setItem(LS.hist, JSON.stringify(mh));
          }
        }

        const initKey = todayKeyLocal();
        setTargetDate(initKey);
      }, []);

      // ---------- Persist ----------
      useEffect(() => localStorage.setItem(LS.user, JSON.stringify(user)), [user]);
      useEffect(() => localStorage.setItem(LS.daily, JSON.stringify(dailyRecords)), [dailyRecords]);
      useEffect(() => localStorage.setItem(LS.max, JSON.stringify(maxRecords)), [maxRecords]);
      useEffect(() => localStorage.setItem(LS.hist, JSON.stringify(history)), [history]);
      useEffect(() => localStorage.setItem(LS.goals, JSON.stringify(goals)), [goals]);
      useEffect(() => localStorage.setItem(LS.goalAch, JSON.stringify(goalAchievements)), [goalAchievements]);
      useEffect(() => localStorage.setItem(LS.sound, String(soundEnabled)), [soundEnabled]);

      // targetDate change: load records
      useEffect(() => {
        if (dailyRecords[targetDate]) setRecords(dailyRecords[targetDate]);
        else setRecords({});
      }, [targetDate, dailyRecords]);

      // ---------- Derived ----------
      const gradeCategory = useMemo(() => {
        if (user.grade <= 2) return "low";
        if (user.grade <= 4) return "mid";
        return "high";
      }, [user.grade]);

      const currentLevelSet = useMemo(() => {
        return levelsData[gradeCategory]
          .map(l => {
            const name = (l.name !== undefined) ? l.name : `${l.level}Á¥ö`;
            return { ...l, name };
          })
          .filter(l => l.name !== "");
      }, [levelsData, gradeCategory]);

      const displayTricks = useMemo(() => {
        const active = new Set();
        levelsData[gradeCategory].forEach(l => {
          if (l.name === "") return;
          if (!l.reqs) return;
          Object.entries(l.reqs).forEach(([k, v]) => {
            if (Number(v) > 0) active.add(k);
          });
        });
        return TRICK_IDS
          .filter(id => active.has(id))
          .map(id => ({
            id,
            color: TRICK_COLORS[id],
            label: (trickNames[gradeCategory] && trickNames[gradeCategory][id]) ? trickNames[gradeCategory][id] : DEFAULT_TRICK_NAMES[gradeCategory][id]
          }));
      }, [levelsData, gradeCategory, trickNames]);

      const calculateBestLevel = useCallback((currentRecords, category) => {
        if (!levelsData || !levelsData[category]) return 999;
        const levels = levelsData[category];
        const cleared = levels.filter(lvl => {
          if (lvl.name === "") return false;
          if (!lvl.reqs) return true;
          return Object.entries(lvl.reqs).every(([trickId, requiredCount]) => {
            const cnt = Number(currentRecords[trickId] || 0);
            if (!requiredCount || requiredCount <= 0) return true;
            return cnt >= requiredCount;
          });
        }).map(l => l.level);
        if (cleared.length === 0) return 999;
        return Math.min(...cleared);
      }, [levelsData]);

      const clearedLevels = useMemo(() => {
        return currentLevelSet
          .filter(lvl => Object.entries(lvl.reqs).every(([trickId, requiredCount]) => {
            const currentCount = Number(maxRecords[trickId] || 0);
            if (!requiredCount || requiredCount <= 0) return true;
            return currentCount >= requiredCount;
          }))
          .map(l => l.level);
      }, [currentLevelSet, maxRecords]);

      const currentBestLevel = useMemo(() => {
        if (!clearedLevels.length) return null;
        const min = Math.min(...clearedLevels);
        return currentLevelSet.find(l => l.level === min) || null;
      }, [clearedLevels, currentLevelSet]);

      const nextLevels = useMemo(() => {
        const all = levelsData[gradeCategory]
          .map(l => ({...l, name: (l.name !== undefined) ? l.name : `${l.level}Á¥ö`}))
          .filter(l => l.name !== "");
        return all.filter(l => !clearedLevels.includes(l.level));
      }, [levelsData, gradeCategory, clearedLevels]);

      const goalTitle = useMemo(() => (user.grade <= 2 ? "„Å§„Åé„ÅÆ „ÇÇ„Åè„Å≤„Çá„ÅÜÔºà„Åç„ÇÖ„ÅÜ „Å® „Çè„ÅñÔºâ" : "Ê¨°„ÅÆÁõÆÊ®ôÔºàÁ¥ö„Å®ÊäÄÔºâ"), [user.grade]);

      const getTrickLevel = useCallback((trickId) => {
        const count = Number(maxRecords[trickId] || 0);
        if (!count) return null;
        const levels = levelsData[gradeCategory];
        const passed = levels.filter(l => {
          if (l.name === "") return false;
          if (!l.reqs) return false;
          const req = l.reqs[trickId];
          return req !== undefined && req !== null && req > 0 && count >= req;
        });
        if (!passed.length) return null;
        return Math.min(...passed.map(l => l.level));
      }, [maxRecords, levelsData, gradeCategory]);

      const totalsByTrick = useMemo(() => {
        const totals = {};
        displayTricks.forEach(t => totals[t.id] = 0);
        Object.entries(dailyRecords).forEach(([dateKey, rec]) => {
          if (!rec) return;
          displayTricks.forEach(t => {
            const v = Number(rec[t.id] || 0);
            totals[t.id] += (isNaN(v) ? 0 : v);
          });
        });
        return totals;
      }, [dailyRecords, displayTricks]);

      const totalAll = useMemo(() => {
        return displayTricks.reduce((sum, t)=> sum + Number(totalsByTrick[t.id] || 0), 0);
      }, [displayTricks, totalsByTrick]);

      // goals default init when tricks change
      useEffect(() => {
        if (!displayTricks.length) return;
        setGoals(prev => {
          const next = {...prev};
          let changed = false;
          displayTricks.forEach(t => {
            if (next[t.id] === undefined){
              const base = (user.grade <= 2) ? 50 : (user.grade <= 4) ? 120 : 200;
              next[t.id] = base;
              changed = true;
            }
          });
          return changed ? next : prev;
        });
      }, [displayTricks, user.grade]);

      // ÁõÆÊ®ôÈÅîÊàê ‚Üí Ê¨°„ÅÆÁõÆÊ®ôÊèêÊ°àÔºà‚Äª goals „Çí‰øùÂ≠ò„Åó„ÅüÊôÇ„Å†„ÅëÂãï„ÅèÔºùÂÖ•ÂäõÈÄî‰∏≠„Åß„ÅØÂãï„Åã„Å™„ÅÑÔºâ
      useEffect(() => {
        if (!displayTricks.length) return;
        displayTricks.forEach(t => {
          const g = Number(goals[t.id] || 0);
          const total = Number(totalsByTrick[t.id] || 0);
          if (!g || g <= 0) return;

          if (total >= g){
            const key = `${t.id}-${g}`;
            if (!goalAchievements.includes(key)){
              setGoalAchievements(prev => [...prev, key]);
              const nextGoal = Math.ceil(g * 1.2);
              setGoalUpdateModal({ trickId: t.id, oldGoal: g, newGoal: nextGoal });

              if (soundEnabled) soundRef.current?.fanfare();
              confetti.start();
            }
          }
        });
      }, [totalsByTrick, goals, displayTricks, goalAchievements, soundEnabled, confetti]);

      // ---------- Helpers ----------
      const playClick = () => { if (soundEnabled) soundRef.current?.click(); };
      const playSuccess = () => { if (soundEnabled) soundRef.current?.success(); };
      const clamp0 = (n) => Math.max(0, n);

      const recomputeMaxFromDaily = useCallback((nextDaily) => {
        const nextMax = {};
        Object.values(nextDaily).forEach(rec => {
          if (!rec) return;
          TRICK_IDS.forEach(id => {
            const v = Number(rec[id] || 0);
            if (!isNaN(v)){
              nextMax[id] = Math.max(Number(nextMax[id] || 0), v);
            }
          });
        });
        setMaxRecords(nextMax);
        localStorage.setItem(LS.max, JSON.stringify(nextMax));
      }, []);

      // ---------- Actions ----------
      // ‚òÖ‰øÆÊ≠£ÔºöÂÖ•ÂäõÂÄ§„ÇíÂøÖ„Åö„ÄåÊï∞Â≠óÔºà0‰ª•‰∏äÔºâ„Äç„Å´Ê≠£Ë¶èÂåñÔºàÊñáÂ≠ó‚ÜîÊï∞Â≠ó„Åß„ÅÆ„ÉÅ„É©„Å§„Åç„Éª‰∏çÂÆâÂÆö„ÅïÂØæÁ≠ñÔºâ
      const updateRecord = (trickId, count) => {
        const raw = (typeof count === "number") ? String(count) : String(count ?? "");
        const digits = normalizeDigits(raw);
        const n = (digits === "") ? 0 : parseInt(digits, 10);
        const safe = clamp0(isNaN(n) ? 0 : n);
        setRecords(prev => ({ ...prev, [trickId]: safe }));
      };

      // ‚òÖ‰øÆÊ≠£ÔºöÁü¢Âç∞„ÅÆÂ¢óÊ∏õ„ÅØ„ÄåonPointerDown„Äç„ÅßÁ¢∫ÂÆöÔºàiOS„ÅÆ‚Äú„É™„É≠„Éº„Éâ„Å£„ÅΩ„ÅÑ„Éï„É©„ÉÉ„Ç∑„É•‚Äù/„Éï„Ç©„Éº„Ç´„ÇπÁßªÂãï„ÇíÊäëÂà∂Ôºâ
      const stepRecord = (trickId, delta) => {
        setRecords(prev => {
          const cur = Number(prev?.[trickId] || 0);
          const next = clamp0(cur + delta);
          return { ...prev, [trickId]: next };
        });
      };

      const handleConfirmRecord = (trickId) => {
        playClick();

        const currentCount = Number(records[trickId] || 0);
        const currentMax = Number(maxRecords[trickId] || 0);

        const category = gradeCategory;
        const oldBest = calculateBestLevel(maxRecords, category);

        const nextDaily = { ...dailyRecords };
        if (!nextDaily[targetDate]) nextDaily[targetDate] = {};
        nextDaily[targetDate] = { ...nextDaily[targetDate], [trickId]: currentCount };
        setDailyRecords(nextDaily);
        localStorage.setItem(LS.daily, JSON.stringify(nextDaily));

        const nextHistory = { ...history, [targetDate]: true };
        setHistory(nextHistory);
        localStorage.setItem(LS.hist, JSON.stringify(nextHistory));

        let nextMax = { ...maxRecords };
        let isNew = false;
        if (currentCount > currentMax){
          nextMax[trickId] = currentCount;
          setMaxRecords(nextMax);
          localStorage.setItem(LS.max, JSON.stringify(nextMax));
          isNew = true;
        }

        const newBest = calculateBestLevel(nextMax, category);
        if (newBest < oldBest){
          playSuccess();
          confetti.start();
          setCopyToast(true);
          setTimeout(()=>setCopyToast(false), 1400);
        } else if (isNew){
          playSuccess();
        }
      };

      const copyTSV = (tsv) => {
        const ta = document.createElement("textarea");
        ta.value = tsv;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        let ok = false;
        try{ ok = document.execCommand("copy"); }catch(e){}
        document.body.removeChild(ta);
        if (ok){
          setCopyToast(true);
          setTimeout(()=>setCopyToast(false), 1400);
        } else {
          alert("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
        }
      };

      const handleCopyRowToClipboard = () => {
        playClick();
        const header = ["ÂêçÂâç","Â≠¶Âπ¥","ÁµÑ","Áï™","ÁèæÂú®„ÅÆÁ¥ö", ...displayTricks.map(t=>t.label)].join("\t");
        const levelName = currentBestLevel ? currentBestLevel.name : "„Å™„Åó";
        const row = [
          user.name || "ÂêçÁÑ°„Åó",
          user.grade,
          user.classVal || "",
          user.number || "",
          levelName,
          ...displayTricks.map(t => {
            const v = Number(records[t.id] || 0);
            const lv = (() => {
              const levels = levelsData[gradeCategory];
              const passed = levels.filter(l => {
                if (l.name === "") return false;
                if (!l.reqs) return false;
                const req = l.reqs[t.id];
                return req !== undefined && req !== null && req > 0 && v >= req;
              });
              if (!passed.length) return null;
              return Math.min(...passed.map(l => l.level));
            })();
            return lv ? `${v}(${lv}Á¥ö)` : `${v}`;
          })
        ].join("\t");
        copyTSV(header + "\n" + row);
      };

      const handleCopyAllRecordsTSV = () => {
        playClick();
        const headers = ["Êó•‰ªò", ...displayTricks.map(t=>t.label)];
        const rows = [headers.join("\t")];

        const dates = Object.keys(dailyRecords).sort((a,b)=> new Date(a) - new Date(b));
        const totals = {};
        displayTricks.forEach(t=> totals[t.id]=0);

        dates.forEach(dk => {
          const rec = dailyRecords[dk] || {};
          const row = [dk];
          displayTricks.forEach(t => {
            const v = Number(rec[t.id] || 0);
            totals[t.id] += (isNaN(v)?0:v);
            row.push(String(isNaN(v)?0:v));
          });
          rows.push(row.join("\t"));
        });

        const totalRow = ["ÂêàË®à", ...displayTricks.map(t=>String(totals[t.id] || 0))];
        rows.push(totalRow.join("\t"));

        copyTSV(rows.join("\n"));
      };

      const executeImportTSV = () => {
        try{
          const text = (importText || "").trim();
          if (!text){
            alert("„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            return;
          }
          const lines = text.split(/\r?\n/);
          if (lines.length < 2){
            alert("„Éá„Éº„ÇøÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„Å™„ÅÑ„Çà„ÅÜ„Åß„ÅôÔºàË°åÊï∞„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºâ„ÄÇ");
            return;
          }
          const headers = lines[0].split("\t").map(s=>s.trim());
          const dateIdx = headers.findIndex(h => h === "Êó•‰ªò" || h.toLowerCase() === "date");
          if (dateIdx === -1){
            alert("ÂÖàÈ†≠Ë°å„Å´„ÄåÊó•‰ªò„ÄçÂàó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ");
            return;
          }

          const map = {};
          displayTricks.forEach(t => {
            const idx = headers.indexOf(t.label);
            if (idx !== -1) map[t.id] = idx;
          });

          let nextDaily = { ...dailyRecords };
          let nextHistory = { ...history };
          let importedCount = 0;

          for (let i=1;i<lines.length;i++){
            const cols = lines[i].split("\t");
            if (!cols.length) continue;
            const dk = (cols[dateIdx] || "").trim();
            if (!dk || dk === "ÂêàË®à") continue;
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dk)) continue;

            if (!nextDaily[dk]) nextDaily[dk] = {};
            Object.entries(map).forEach(([trickId, idx]) => {
              const v = Number((cols[idx] || "0").trim());
              if (!isNaN(v)) nextDaily[dk][trickId] = v;
            });

            nextHistory[dk] = true;
            importedCount++;
          }

          setDailyRecords(nextDaily);
          setHistory(nextHistory);
          localStorage.setItem(LS.daily, JSON.stringify(nextDaily));
          localStorage.setItem(LS.hist, JSON.stringify(nextHistory));

          recomputeMaxFromDaily(nextDaily);

          setImportModalOpen(false);
          setImportText("");
          playSuccess();
          alert(`${importedCount}Ë°å„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ`);
        }catch(e){
          console.error(e);
          alert("„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Éá„Éº„ÇøÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        }
      };

      const deleteDateRow = (dk) => {
        playClick();
        const nextDaily = {...dailyRecords};
        delete nextDaily[dk];
        setDailyRecords(nextDaily);
        localStorage.setItem(LS.daily, JSON.stringify(nextDaily));

        const nextHistory = {...history};
        delete nextHistory[dk];
        setHistory(nextHistory);
        localStorage.setItem(LS.hist, JSON.stringify(nextHistory));

        recomputeMaxFromDaily(nextDaily);

        if (targetDate === dk){
          setTargetDate(todayKeyLocal());
        }
      };

      // ‚òÖÊó•‰ªòÁßªÂãïÔºà‰∏ÄË¶ß‚Üí„Ç´„É¨„É≥„ÉÄ„Éº„ÅßÊó•‰ªòÂ§âÊõ¥Ôºâ
      const moveDateKey = (fromKey, toKey) => {
        if (!fromKey || !toKey) return;
        if (fromKey === toKey) return;

        const src = dailyRecords[fromKey];
        if (!src) return;

        const nextDaily = {...dailyRecords};
        const nextHistory = {...history};

        let nextRec = {...src};

        if (nextDaily[toKey]){
          const merge = window.confirm(
            "Â§âÊõ¥ÂÖà„ÅÆÊó•‰ªò„Å´„ÇÇË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n\nOKÔºöÂêà‰ΩìÔºàË∂≥„ÅóÁÆóÔºâ\n„Ç≠„É£„É≥„Çª„É´Ôºö‰∏äÊõ∏„Åç"
          );
          if (merge){
            const dst = nextDaily[toKey] || {};
            const merged = {...dst};
            TRICK_IDS.forEach(id => {
              const a = Number(dst[id] || 0);
              const b = Number(src[id] || 0);
              const s = (isNaN(a)?0:a) + (isNaN(b)?0:b);
              if (s) merged[id] = s;
            });
            nextRec = merged;
          } else {
            nextRec = {...src};
          }
        }

        nextDaily[toKey] = nextRec;
        delete nextDaily[fromKey];

        nextHistory[toKey] = true;
        delete nextHistory[fromKey];

        setDailyRecords(nextDaily);
        setHistory(nextHistory);
        localStorage.setItem(LS.daily, JSON.stringify(nextDaily));
        localStorage.setItem(LS.hist, JSON.stringify(nextHistory));

        if (targetDate === fromKey) setTargetDate(toKey);

        recomputeMaxFromDaily(nextDaily);
      };

      const hardResetAll = () => {
        const ok = window.confirm("„ÄêÊúÄÁµÇÁ¢∫Ë™ç„Äë„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„ÇøÔºàÂêçÂâç„ÉªË®òÈå≤„ÉªÁõÆÊ®ô„ÉªË®≠ÂÆöÔºâ„ÇíÊ∂à„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü");
        if (!ok) return;
        Object.values(LS).forEach(k => localStorage.removeItem(k));
        location.reload();
      };

      const softResetRecordsOnly = () => {
        const ok = window.confirm("Ë®òÈå≤Ôºà„Åå„Çì„Å∞„Çä„Éª„Éô„Çπ„Éà„ÉªÂ±•Ê≠¥„ÉªÁõÆÊ®ôÈÅîÊàêÂ±•Ê≠¥Ôºâ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÄÇ\nÊ§úÂÆöË°®ÔºàÂÖàÁîüË®≠ÂÆöÔºâ„ÅØÊÆã„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü");
        if (!ok) return;
        setRecords({});
        setDailyRecords({});
        setMaxRecords({});
        setHistory({});
        setGoalAchievements([]);
        localStorage.removeItem(LS.records);
        localStorage.removeItem(LS.daily);
        localStorage.removeItem(LS.max);
        localStorage.removeItem(LS.hist);
        localStorage.removeItem(LS.goalAch);
        setTargetDate(todayKeyLocal());
        setActiveTab("home");
      };

      // ---------- Teacher settings handlers ----------
      const handleSaveSettings = () => {
        localStorage.setItem(LS.levels, JSON.stringify(levelsData));
        localStorage.setItem(LS.names, JSON.stringify(trickNames));
        localStorage.setItem(LS.ver, DATA_VERSION);
        alert("Ë®≠ÂÆö„Çí„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ\nÁîüÂæí„Å´ÈÖç„ÇãÂ†¥Âêà„ÅØ„ÄåÂÖêÁ´•ÈÖç‰ªòÁî®„Éï„Ç°„Ç§„É´„ÇíÊõ∏„ÅçÂá∫„Åó„Äç„Éú„Çø„É≥„Çí‰Ωø„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      };

      const handleDownloadJson = () => {
        const data = { levelsData, trickNames, version: DATA_VERSION };
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `nawatobi-settings-${todayKeyLocal()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const fileInputRef = useRef(null);
      const handleUploadJson = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try{
            const data = JSON.parse(ev.target.result);
            if (data.levelsData && data.trickNames){
              setLevelsData(data.levelsData);
              setTrickNames(data.trickNames);
              localStorage.setItem(LS.levels, JSON.stringify(data.levelsData));
              localStorage.setItem(LS.names, JSON.stringify(data.trickNames));
              localStorage.setItem(LS.ver, DATA_VERSION);
              alert("Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„ÄÅÂæ©ÂÖÉ„Åó„Åæ„Åó„ÅüÔºÅ");
            } else {
              alert("ÁÑ°Âäπ„Å™„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô„ÄÇ");
            }
          }catch(err){
            console.error(err);
            alert("„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
          }
        };
        reader.readAsText(file);
        e.target.value = "";
      };

      const handleExportHtml = () => {
        const scriptContent = document.getElementById("app-script").textContent;

        const bakedLevels = "const DEFAULT_LEVELS_DATA = " + JSON.stringify(levelsData, null, 2) + ";";
        const bakedNames  = "const DEFAULT_TRICK_NAMES = " + JSON.stringify(trickNames, null, 2) + ";";
        const bakedVer    = 'const DATA_VERSION = "' + DATA_VERSION + "-custom-" + Date.now() + '";';

        let newScript = scriptContent
          .replace(/const DEFAULT_LEVELS_DATA = \{[\s\S]*?\};/, bakedLevels)
          .replace(/const DEFAULT_TRICK_NAMES = \{[\s\S]*?\};/, bakedNames)
          .replace(/const DATA_VERSION = ".*?";/, bakedVer)
          .replace("const IS_TEACHER_MODE = true;", "const IS_TEACHER_MODE = false;");

        const html =
`<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>„Å™„Çè„Å®„Å≥Ê§úÂÆö„Ç´„Éº„Éâ</title>
  <script src="https://cdn.tailwindcss.com"><\/script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
  <\/script>
  <style>
    :root{ --safe-bottom: env(safe-area-inset-bottom, 0px); }
    html, body{ overflow-x:hidden; }
    *{ -webkit-tap-highlight-color: transparent; }
    body{
      font-family:"M PLUS Rounded 1c",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      padding-bottom:calc(96px + var(--safe-bottom));
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    input[type="number"]{ -moz-appearance:textfield; }
    .custom-scrollbar::-webkit-scrollbar{height:8px;width:8px;}
    .custom-scrollbar::-webkit-scrollbar-track{background:#f1f5f9;}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px;}
    .custom-scrollbar::-webkit-scrollbar-thumb:hover{background:#94a3b8;}
    .sticky-col{position:sticky;left:0;z-index:10;background:white;border-right:2px solid #e2e8f0;}
    .sticky-corner{position:sticky;left:0;top:0;z-index:30;background:#f8fafc;border-right:2px solid #e2e8f0;border-bottom:2px solid #e2e8f0;}
    @keyframes popIn{0%{transform:scale(.92);opacity:0}100%{transform:scale(1);opacity:1}}
    .animate-popIn{animation:popIn .28s cubic-bezier(.175,.885,.32,1.2) both;}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .animate-fadeInUp{animation:fadeInUp .25s ease-out both;}
    @keyframes confettiBg{0%{background-position:0 0}100%{background-position:120px 120px}}
    .bg-confetti{
      background-image:radial-gradient(#FCD34D 22%, transparent 22%),radial-gradient(#FB7185 22%, transparent 22%),radial-gradient(#60A5FA 22%, transparent 22%);
      background-color:#fff;
      background-position:0 0,60px 30px,30px 60px;
      background-size:120px 120px;
      animation:confettiBg 4s linear infinite;
    }
  </style>
</head>
<body class="bg-sky-50 text-slate-800 select-none">
  <div id="root"></div>
  <script type="text/babel" data-type="module" id="app-script">
${newScript}
  <\/script>
</body>
</html>`;

        const blob = new Blob([html], {type:"text/html"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `nawatobi-distribute-${todayKeyLocal()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const handleLevelReqChange = (category, levelIndex, trickId, value) => {
        const newData = { ...levelsData };
        const val = parseInt(value);
        if (isNaN(val) || val <= 0) {
          if (newData[category][levelIndex].reqs) delete newData[category][levelIndex].reqs[trickId];
        } else {
          if (!newData[category][levelIndex].reqs) newData[category][levelIndex].reqs = {};
          newData[category][levelIndex].reqs[trickId] = val;
        }
        setLevelsData(newData);
      };

      const handleTrickNameChange = (category, trickId, newName) => {
        const newNames = { ...trickNames };
        newNames[category][trickId] = newName;
        setTrickNames(newNames);
      };

      const handleLevelNameChange = (category, levelIndex, newName) => {
        const newData = { ...levelsData };
        newData[category][levelIndex].name = newName;
        setLevelsData(newData);
      };

      const handleResetSettings = () => {
        const ok = window.confirm("Êú¨ÂΩì„Å´ÂàùÊúüË®≠ÂÆö„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü\n„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åó„ÅüÂÜÖÂÆπ„ÅØÊ∂à„Åà„Å¶„Åó„Åæ„ÅÑ„Åæ„Åô„ÄÇ");
        if (!ok) return;
        setLevelsData(DEFAULT_LEVELS_DATA);
        setTrickNames(DEFAULT_TRICK_NAMES);
        localStorage.removeItem(LS.levels);
        localStorage.removeItem(LS.names);
        localStorage.removeItem(LS.ver);
        alert("ÂàùÊúüË®≠ÂÆö„Å´Êàª„Åó„Åæ„Åó„Åü„ÄÇ");
        location.reload();
      };

      // =========================
      // ÂÖàÁîüÁî®ÔºöÊ§úÂÆöË°®‰ΩúÊàêÁîªÈù¢
      // =========================
      if (activeTab === "settings" && IS_TEACHER_MODE){
        return (
          <div className="min-h-screen bg-slate-50 pb-24">
            <header className="sticky top-0 z-40 bg-gradient-to-r from-slate-900 to-slate-700 text-white px-4 py-3 shadow-lg">
              <div className="max-w-5xl mx-auto flex items-center justify-between gap-2 flex-wrap">
                <div className="flex items-center gap-2">
                  <button type="button" onClick={() => { playClick(); setActiveTab("home"); }} className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 font-black text-sm">
                    ‚Üê „ÇÇ„Å©„Çã
                  </button>
                  <div className="flex items-center gap-2">
                    <Settings size={18}/>
                    <div className="font-extrabold">Ê§úÂÆöË°®‰ΩúÊàêÔºàÂÖàÁîüÁî®Ôºâ</div>
                  </div>
                </div>

                <div className="flex gap-2 items-center">
                  <input type="file" ref={fileInputRef} accept=".json" onChange={handleUploadJson} className="hidden" />
                  <button type="button" onClick={() => { playClick(); fileInputRef.current?.click(); }} className="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-xl font-black text-xs flex items-center gap-2 shadow">
                    <Upload size={16}/> Ë®≠ÂÆöË™≠Ëæº
                  </button>
                  <button type="button" onClick={() => { playClick(); handleDownloadJson(); }} className="bg-orange-600 hover:bg-orange-500 px-3 py-2 rounded-xl font-black text-xs flex items-center gap-2 shadow">
                    <Download size={16}/> Ë®≠ÂÆö‰øùÂ≠ò
                  </button>
                  <button type="button" onClick={() => { playClick(); handleExportHtml(); }} className="bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded-xl font-black text-xs flex items-center gap-2 shadow">
                    <FileDown size={16}/> ÂÖêÁ´•ÈÖç‰ªòÁî®„ÇíÊõ∏„ÅçÂá∫„Åó
                  </button>
                  <button type="button" onClick={() => { playClick(); handleSaveSettings(); }} className="bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded-xl font-black text-xs flex items-center gap-2 shadow">
                    <Save size={16}/> ‰øùÂ≠ò
                  </button>
                </div>
              </div>
            </header>

            <main className="max-w-5xl mx-auto p-4">
              <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
                <div className="flex items-center justify-between flex-wrap gap-2">
                  <div className="font-extrabold text-slate-700 flex items-center gap-2">
                    <Sparkles className="text-yellow-500" size={18}/>
                    ÊäÄÂêç„ÉªÁ¥öÂêç„ÉªÂøÖË¶ÅÂõûÊï∞„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫
                  </div>
                  <div className="text-xs text-slate-500 font-bold">
                    ‚Äª Á¥öÂêç„ÇíÁ©∫Ê¨Ñ„Å´„Åô„Çã„Å®„ÄÅ„Åù„ÅÆÁ¥ö„ÅØË°®Á§∫„Åï„Çå„Åæ„Åõ„ÇìÔºàÁÑ°ÂäπÂåñÔºâ
                  </div>
                </div>

                <div className="mt-3 flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                  {[
                    {id:"low", label:"1„Éª2Âπ¥Áî®"},
                    {id:"mid", label:"3„Éª4Âπ¥Áî®"},
                    {id:"high", label:"5„Éª6Âπ¥Áî®"}
                  ].map(tab => (
                    <button
                      type="button"
                      key={tab.id}
                      onClick={() => { playClick(); setSettingTab(tab.id); }}
                      className={`px-4 py-2 rounded-full font-black whitespace-nowrap transition ${
                        settingTab === tab.id ? "bg-slate-900 text-white" : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                      }`}
                    >
                      {tab.label}
                    </button>
                  ))}
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
                <div className="overflow-x-auto custom-scrollbar">
                  <table className="w-full text-sm border-collapse">
                    <thead className="sticky top-0 z-20 bg-slate-100">
                      <tr>
                        <th className="sticky-corner p-3 min-w-[88px] text-center font-black">Á¥ö</th>
                        {TRICK_IDS.map(trickId => (
                          <th key={trickId} className="p-2 border-b border-slate-200 min-w-[110px]">
                            <input
                              value={trickNames[settingTab][trickId]}
                              onChange={(e) => handleTrickNameChange(settingTab, trickId, e.target.value)}
                              className="w-full bg-transparent text-center font-black text-xs border-b border-dashed border-slate-300 focus:outline-none focus:border-sky-500 select-text py-1"
                            />
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {levelsData[settingTab].map((lvl, idx) => (
                        <tr key={lvl.level} className="hover:bg-slate-50">
                          <td className="sticky-col p-2 bg-slate-50 text-center font-black text-slate-700">
                            <input
                              value={lvl.name !== undefined ? lvl.name : `${lvl.level}Á¥ö`}
                              placeholder={`${lvl.level}Á¥ö`}
                              onChange={(e) => handleLevelNameChange(settingTab, idx, e.target.value)}
                              className={`w-full bg-transparent text-center font-black border-b border-transparent focus:border-sky-500 focus:outline-none select-text ${
                                lvl.name === "" ? "text-red-300 bg-red-50" : ""
                              }`}
                            />
                          </td>
                          {TRICK_IDS.map(trickId => {
                            const v = (lvl.reqs && lvl.reqs[trickId]) ? lvl.reqs[trickId] : "";
                            return (
                              <td key={trickId} className="p-1 border-b border-slate-100">
                                <input
                                  type="number"
                                  value={v}
                                  onChange={(e) => handleLevelReqChange(settingTab, idx, trickId, e.target.value)}
                                  placeholder="-"
                                  className={`w-full text-center rounded-lg p-1 focus:outline-none focus:ring-2 focus:ring-sky-400 select-text ${
                                    v ? "bg-sky-50 text-sky-700 font-black" : "text-slate-300"
                                  }`}
                                />
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              <div className="mt-8 text-center">
                <button type="button" onClick={() => { playClick(); handleResetSettings(); }} className="text-xs font-black text-red-400 hover:text-red-600 underline inline-flex items-center gap-2">
                  <RotateCcw size={14}/> Ë®≠ÂÆö„ÇíÂàùÊúüÂÄ§„Å´Êàª„Åô
                </button>
              </div>
            </main>
          </div>
        );
      }

      // =========================
      // UI: ÂÖ±ÈÄö„Éò„ÉÉ„ÉÄ„ÉºÔºà‚òÖ„ÉÅ„Ç´„ÉÅ„Ç´Èò≤Ê≠¢Ôºö„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å®„Åó„Å¶‰Ωø„Çè„ÅöÈñ¢Êï∞Âëº„Å≥Âá∫„ÅóÔºâ
      // =========================
      const Header = () => (
        <header className="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-sky-100 shadow-sm">
          <div className="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between gap-2">
            <div className="flex items-center gap-2">
              <div className="bg-gradient-to-br from-sky-400 to-indigo-500 text-white p-2 rounded-2xl shadow">
                <Activity size={20} strokeWidth={2.8}/>
              </div>
              <div>
                <div className="text-[11px] font-extrabold text-slate-400 leading-none">Â§ßÂ§öÂñúÁî∫Á´ãÂ§ßÂ§öÂñúÂ∞èÂ≠¶Ê†°</div>
                <div className="text-base font-black text-sky-700 leading-tight">„Å™„Çè„Å®„Å≥Ê§úÂÆö„Ç´„Éº„Éâ</div>
              </div>
            </div>

            <div className="flex items-center gap-2">
              <button
                type="button"
                onClick={() => { playClick(); setSoundEnabled(v => !v); }}
                className="px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 hover:bg-slate-100 text-slate-600 font-black text-xs flex items-center gap-2 active:scale-95"
                title="„Çµ„Ç¶„É≥„ÉâON/OFF"
              >
                {soundEnabled ? <Volume2 size={16}/> : <VolumeX size={16}/>}
                <span className="hidden sm:inline">{soundEnabled ? "„Çµ„Ç¶„É≥„ÉâON" : "„Çµ„Ç¶„É≥„ÉâOFF"}</span>
              </button>

              <div className="text-right">
                <div className="text-[10px] text-slate-400 font-black">„Åí„Çì„Åñ„ÅÑ„ÅÆ„Åç„ÇÖ„ÅÜ</div>
                <div className="text-xl font-black text-pink-500 leading-none">
                  {currentBestLevel ? currentBestLevel.name : "‚Äï"}
                </div>
              </div>
            </div>
          </div>
        </header>
      );

      // =========================
      // HOME
      // =========================
      const HomeView = () => (
        <div className="space-y-4 animate-fadeInUp">
          <div className="bg-white rounded-3xl shadow-xl border-4 border-sky-100 overflow-hidden">
            <div className="relative bg-gradient-to-r from-sky-50 to-indigo-50 p-4 border-b border-sky-100 text-center">
              {IS_TEACHER_MODE && (
                <button
                  type="button"
                  onClick={() => { playClick(); setActiveTab("settings"); }}
                  className="absolute top-3 right-3 px-3 py-2 rounded-xl bg-white/70 hover:bg-white border border-sky-100 text-sky-600 font-black text-xs flex items-center gap-2 shadow-sm active:scale-95"
                >
                  <Settings size={16}/> Ê§úÂÆöË°®„ÇíÁ∑®ÈõÜ
                </button>
              )}
              <div className="inline-flex items-center justify-center w-12 h-12 rounded-2xl bg-white shadow-sm border border-sky-100 text-sky-600 mb-2">
                <Sparkles size={26}/>
              </div>
              <div className="text-xl font-black text-slate-800">„Å™„Çè„Å®„Å≥Ê§úÂÆö„Ç´„Éº„Éâ</div>
              <div className="text-[11px] font-bold text-slate-500 mt-1">
                ‚Äú„Åç„Çç„Åè‚Äù „Å® ‚Äú„Åî„ÅÜ„Åë„ÅÑ‚Äù „Åß„ÄÅ„Å©„Çì„Å©„Çì „ÅÜ„Åæ„Åè„Å™„ÇãÔºÅ
              </div>
            </div>

            <div className="p-4">
              <div className="bg-sky-50/70 p-3 rounded-2xl border-2 border-sky-100 mb-4">
                <div className="flex items-center gap-2 text-sky-700 mb-2">
                  <Pencil size={14}/>
                  <div className="text-xs font-black">„Å™„Åæ„Åà„Çí „Åã„ÅÑ„Å¶„Å≠</div>
                </div>

                <div className="grid grid-cols-12 gap-2">
                  <div className="col-span-3">
                    <select
                      value={user.grade}
                      onChange={(e)=> setUser(prev => ({...prev, grade: Number(e.target.value)}))}
                      className="w-full p-2 rounded-xl border border-sky-200 bg-white font-black select-text"
                    >
                      {[1,2,3,4,5,6].map(g => <option key={g} value={g}>{g} Âπ¥</option>)}
                    </select>
                  </div>
                  <div className="col-span-3">
                    <input
                      value={user.classVal}
                      onChange={(e)=> setUser(prev => ({...prev, classVal: e.target.value}))}
                      placeholder="ÁµÑ"
                      className="w-full p-2 rounded-xl border border-sky-200 bg-white font-black text-center select-text"
                    />
                  </div>
                  <div className="col-span-3">
                    <input
                      value={user.number}
                      onChange={(e)=> setUser(prev => ({...prev, number: e.target.value}))}
                      placeholder="Áï™"
                      className="w-full p-2 rounded-xl border border-sky-200 bg-white font-black text-center select-text"
                    />
                  </div>
                  <div className="col-span-12 sm:col-span-3">
                    <input
                      value={user.name}
                      onChange={(e)=> setUser(prev => ({...prev, name: e.target.value}))}
                      placeholder="„Å™„Åæ„Åà"
                      className="w-full p-2 rounded-xl border border-sky-200 bg-white font-black select-text"
                    />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 gap-3">
                <button
                  type="button"
                  onClick={()=>{ playClick(); setTargetDate(todayKeyLocal()); setActiveTab("input"); }}
                  className="group flex items-center gap-3 p-3 rounded-2xl border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 shadow-sm hover:shadow-md active:scale-95 transition"
                >
                  <div className="w-11 h-11 rounded-2xl bg-blue-500 text-white flex items-center justify-center shadow group-hover:scale-110 transition">
                    <RefreshCw size={20}/>
                  </div>
                  <div className="text-left">
                    <div className="text-lg font-black text-blue-700 leading-tight">„Åç„Çç„Åè „Çí „Å§„Åë„Çã</div>
                    <div className="text-[11px] font-bold text-blue-500">‰ªäÊó•„ÇÇ„Éô„Çπ„Éà„Å´„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ</div>
                  </div>
                </button>

                <button
                  type="button"
                  onClick={()=>{ playClick(); setActiveTab("stats"); }}
                  className="group flex items-center gap-3 p-3 rounded-2xl border-2 border-orange-200 bg-orange-50 hover:bg-orange-100 shadow-sm hover:shadow-md active:scale-95 transition"
                >
                  <div className="w-11 h-11 rounded-2xl bg-orange-500 text-white flex items-center justify-center shadow group-hover:scale-110 transition">
                    <Trophy size={20}/>
                  </div>
                  <div className="text-left">
                    <div className="text-lg font-black text-orange-700 leading-tight">„Åî„ÅÜ„Åë„ÅÑ „Å® „ÇÇ„Åè„Å≤„Çá„ÅÜ</div>
                    <div className="text-[11px] font-bold text-orange-500">„Åü„Åæ„Å£„ÅüÂõûÊï∞„ÅßÁõÆÊ®ôÈÅîÊàêÔºÅ</div>
                  </div>
                </button>

                <button
                  type="button"
                  onClick={()=>{ playClick(); setActiveTab("cert"); }}
                  className="group flex items-center gap-3 p-3 rounded-2xl border-2 border-pink-200 bg-pink-50 hover:bg-pink-100 shadow-sm hover:shadow-md active:scale-95 transition"
                >
                  <div className="w-11 h-11 rounded-2xl bg-pink-500 text-white flex items-center justify-center shadow group-hover:scale-110 transition">
                    <Award size={20}/>
                  </div>
                  <div className="text-left">
                    <div className="text-lg font-black text-pink-700 leading-tight">„Å´„Çì„Å¶„ÅÑ„Åó„Çá„ÅÜ</div>
                    <div className="text-[11px] font-bold text-pink-500">„ÅÑ„Åæ„ÅÆÁ¥ö„Çí„Åã„Åè„Å´„Çì</div>
                  </div>
                </button>

                <button
                  type="button"
                  onClick={()=>{ playClick(); setActiveTab("history"); setHistoryView("calendar"); }}
                  className="group flex items-center gap-3 p-3 rounded-2xl border-2 border-emerald-200 bg-emerald-50 hover:bg-emerald-100 shadow-sm hover:shadow-md active:scale-95 transition"
                >
                  <div className="w-11 h-11 rounded-2xl bg-emerald-500 text-white flex items-center justify-center shadow group-hover:scale-110 transition">
                    <Calendar size={20}/>
                  </div>
                  <div className="text-left">
                    <div className="text-lg font-black text-emerald-700 leading-tight">„Åå„Çì„Å∞„Çä</div>
                    <div className="text-[11px] font-bold text-emerald-500">„Ç´„É¨„É≥„ÉÄ„Éº / ‰∏ÄË¶ß</div>
                  </div>
                </button>
              </div>

              <div className="mt-4 text-center">
                <button
                  type="button"
                  onClick={()=>{ playClick(); setDeleteModal({type:"soft"}); }}
                  className="text-[11px] font-black text-slate-300 hover:text-red-400 underline inline-flex items-center gap-2"
                >
                  <RotateCcw size={12}/> Ë®òÈå≤„Çí„É™„Çª„ÉÉ„ÉàÔºàË®≠ÂÆö„ÅØÊÆã„ÅôÔºâ
                </button>
                {IS_TEACHER_MODE && (
                  <div className="mt-2">
                    <button
                      type="button"
                      onClick={()=>{ playClick(); setDeleteModal({type:"hard"}); }}
                      className="text-[11px] font-black text-red-300 hover:text-red-600 underline inline-flex items-center gap-2"
                    >
                      <Trash2 size={12}/> ÂÆåÂÖ®„É™„Çª„ÉÉ„ÉàÔºàË®≠ÂÆö„ÇÇÊ∂à„ÅôÔºâ
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm">
            <div className="flex items-start gap-3">
              <div className="w-10 h-10 rounded-2xl bg-yellow-100 text-yellow-700 flex items-center justify-center border border-yellow-200">
                <Star size={18}/>
              </div>
              <div>
                <div className="font-black text-slate-700">„Ç≥„ÉÑ</div>
                <div className="text-sm text-slate-500 font-bold leading-relaxed">
                  „Äå„Åë„Å£„Å¶„ÅÑ„Äç„Çí„Åä„Åô„Å®„ÄÅ<span className="text-sky-600 font-black">‰øùÂ≠ò</span>„Åï„Çå„Å¶„ÄÅ<span className="text-orange-600 font-black">„Åî„ÅÜ„Åë„ÅÑ</span>„Å´„ÇÇ„Åü„Åæ„Çã„Çà„ÄÇ
                </div>
              </div>
            </div>
          </div>
        </div>
      );

      // =========================
// INPUTÔºà‚òÖ‰øÆÊ≠£ÔºöÁü¢Âç∞Â¢óÊ∏õ„ÅÆ‚Äú„É™„É≠„Éº„Éâ„Å£„ÅΩ„ÅÑÂäπÊûú‚Äù„ÇíÊäëÊ≠¢ + Â∞èÁîªÈù¢„ÅÆÊúÄÈÅ©ÂåñÔºâ
// =========================
const InputView = () => {
  const today = todayKeyLocal();
  const hasAny = Object.keys(records || {}).some(k => Number(records[k]||0) > 0);

  return (
    <div className="space-y-4 animate-fadeInUp inputView">
      {/* ‚òÖËøΩÂä†ÔºöÊäÄÂêç„ÅÆ„Äå‚Ä¶Ôºà„Éª„Éª„ÉªÔºâ„ÄçÁúÅÁï•„ÇíËß£Èô§Ôºàtruncate / line-clamp „ÇíÁÑ°ÂäπÂåñÔºâ */}
      <style>{`
        .inputView .truncate{
          overflow: visible !important;
          white-space: normal !important;
          text-overflow: clip !important;
        }
        .inputView .line-clamp-1,
        .inputView .line-clamp-2,
        .inputView .line-clamp-3{
          -webkit-line-clamp: unset !important;
          display: block !important;
          overflow: visible !important;
        }
      `}</style>

      <div className="bg-white rounded-3xl p-4 shadow-sm border border-slate-100">
        <div className="flex items-end justify-between gap-2 flex-wrap">
          <div>
            <div className="flex items-center gap-2">
              <RefreshCw size={20} className="text-sky-500"/>
              <div className="text-lg font-black text-slate-700">„Åç„Çç„Åè „Çí „ÅÑ„Çå„Çà„ÅÜ</div>
            </div>
            <div className="text-[11px] font-bold text-slate-400 mt-1">
              „Å≤„Å£„Åã„Åã„Çâ„Åö„Å´ <span className="text-pink-500 font-black">„Çå„Çì„Åû„Åè</span> „Åß„Å®„Åπ„ÅüÂõûÊï∞
            </div>
          </div>

          <div className="flex items-center gap-2">
            <div className="relative">
              <input
                type="date"
                value={targetDate}
                onChange={(e)=> { playClick(); setTargetDate(e.target.value); }}
                className="pl-9 pr-3 py-2 rounded-xl border border-slate-200 text-xs font-black text-slate-600 focus:outline-none focus:border-sky-400"
              />
              <CalendarDays size={16} className="absolute left-3 top-2.5 text-slate-400 pointer-events-none"/>
            </div>
            <button
              type="button"
              onClick={()=>{ playClick(); setTargetDate(today); }}
              className="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-black text-xs active:scale-95"
            >
              ‰ªäÊó•
            </button>
            <button
              type="button"
              onClick={handleCopyRowToClipboard}
              className="px-3 py-2 rounded-xl bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 text-emerald-700 font-black text-xs flex items-center gap-2 active:scale-95"
            >
              <Copy size={16}/> 1Ë°å„Ç≥„Éî„Éº
            </button>
          </div>
        </div>

        {(targetDate !== today || hasAny) && (
          <div className="mt-3 bg-orange-50 border border-orange-200 text-orange-600 font-black text-xs text-center py-2 rounded-xl">
            Êï∞Â≠ó„Çí„Åã„Åà„Åü„Çâ„Äå„Åë„Å£„Å¶„ÅÑ„Äç„Çí„Åä„Åó„Å¶„Å≠
          </div>
        )}

        <div className="mt-4 space-y-3">
          {displayTricks.map(trick => {
            const currentNum = Number(records[trick.id] || 0);

            const savedVal = dailyRecords[targetDate]?.[trick.id];
            const savedExists = savedVal !== undefined && savedVal !== null && savedVal !== "";
            const savedNum = Number(savedVal || 0);

            const isSaved = savedExists && (currentNum === savedNum);

            const best = Number(maxRecords[trick.id] || 0);
            const bestLevel = getTrickLevel(trick.id);

            const borderClass = trick.color.split(" ").find(s => s.startsWith("border-")) || "border-slate-200";

                  return (
                    <div key={trick.id} className={`p-2.5 sm:p-3 rounded-2xl border-2 ${borderClass} bg-white hover:border-sky-300 transition`}>
                      <div className="flex items-center gap-2 flex-wrap">
                        {/* Â∑¶ÔºöÊäÄÂêç„Å™„Å©ÔºàÂ∞èÁîªÈù¢„ÅßÁ∏Æ„ÇÄÔºâ */}
                        <div className="flex items-center gap-2 flex-1 min-w-0">
                          <div className={`w-9 h-9 sm:w-11 sm:h-11 rounded-2xl flex items-center justify-center font-black shadow-sm ${trick.color}`}>
                            {trick.label.substring(0,1)}
                          </div>

                          <div className="min-w-0">
                            <div className="font-black text-slate-800 flex items-center gap-1.5 min-w-0">
                              {/* ÊäÄÂêçÔºö1Ë°åÂõ∫ÂÆöÔºà„Åü„Å†„ÅóÂ∞èÁîªÈù¢„Å´Âèé„Åæ„Çã„Çà„ÅÜmaxÂπÖ„ÇíÂ∞è„Åï„ÅèÔºâ */}
                              <span
                                className="truncate whitespace-nowrap max-w-[130px] sm:max-w-[260px]"
                                title={trick.label}
                              >
                                {trick.label}
                              </span>

                              {/* ÊúÄÈ´òÔºöÂ∞èÁîªÈù¢„ÅØÁü≠Á∏ÆË°®Á§∫ */}
                              <span className="text-[11px] sm:text-xs font-black text-orange-700 bg-orange-50 border border-orange-200 px-2 py-0.5 rounded-full whitespace-nowrap">
                                <span className="sm:hidden">‚òÖ{best}</span>
                                <span className="hidden sm:inline">ÊúÄÈ´ò: {best}</span>
                              </span>

                              {bestLevel && (
                                <span className="text-[11px] sm:text-xs font-black bg-yellow-100 text-yellow-800 border border-yellow-300 px-2 py-0.5 rounded-full whitespace-nowrap">
                                  {bestLevel}Á¥ö
                                </span>
                              )}
                            </div>

                            <div className="text-[10px] sm:text-[11px] font-bold text-slate-400">
                              ‰ªäÊó•„ÅÆË®òÈå≤Ôºö{savedExists ? savedNum : "Êú™‰øùÂ≠ò"}
                            </div>
                          </div>
                        </div>

                        {/* Âè≥ÔºöÂÖ•ÂäõÔºàÂõ∫ÂÆöÂπÖ„ÄÇ„Éú„Çø„É≥Â∞è„Åï„ÇÅÔºâ */}
                        <div className="flex items-center gap-1.5 sm:gap-2 shrink-0 ml-auto">
                          <button
                            type="button"
                            onPointerDown={(e)=>{
                              e.preventDefault();
                              playClick();
                              stepRecord(trick.id, -1);
                            }}
                            onContextMenu={(e)=>e.preventDefault()}
                            className="w-10 h-10 sm:w-11 sm:h-11 rounded-2xl bg-slate-50 border border-slate-200 text-slate-400 flex items-center justify-center active:scale-95 hover:bg-slate-100"
                            aria-label="1Âõû„Å∏„Çâ„Åô"
                          >
                            <ChevronDown size={20}/>
                          </button>

                          <div className="flex items-end gap-1">
                            <input
                              type="text"
                              inputMode="numeric"
                              pattern="\d*"
                              value={Number(records[trick.id] || 0) > 0 ? String(records[trick.id]) : ""}
                              placeholder="0"
                              onFocus={(e)=> requestAnimationFrame(()=>e.target.select())}
                              onChange={(e)=> updateRecord(trick.id, e.target.value)}
                              className={`w-16 sm:w-20 text-center text-2xl sm:text-3xl font-black bg-transparent border-b-4 focus:outline-none p-1 select-text ${
                                isSaved ? "text-sky-600 border-sky-200" : "text-slate-900 border-slate-200 focus:border-sky-400"
                              }`}
                            />
                            <div className="text-[11px] sm:text-xs font-black text-slate-400 mb-2">Âõû</div>
                          </div>

                          <button
                            type="button"
                            onPointerDown={(e)=>{
                              e.preventDefault();
                              playClick();
                              stepRecord(trick.id, +1);
                            }}
                            onContextMenu={(e)=>e.preventDefault()}
                            className="w-10 h-10 sm:w-11 sm:h-11 rounded-2xl bg-sky-100 border border-sky-200 text-sky-700 flex items-center justify-center active:scale-95 hover:bg-sky-200"
                            aria-label="1Âõû„Åµ„ÇÑ„Åô"
                          >
                            <ChevronUp size={20}/>
                          </button>

                          <button
                            type="button"
                            onClick={()=>handleConfirmRecord(trick.id)}
                            className={`ml-1 w-14 sm:w-16 h-10 sm:h-11 rounded-2xl font-black text-[11px] sm:text-xs flex flex-col items-center justify-center shadow-sm active:scale-95 transition ${
                              isSaved
                                ? "bg-sky-50 border-2 border-sky-200 text-sky-700"
                                : "bg-emerald-500 hover:bg-emerald-600 text-white animate-pulse"
                            }`}
                          >
                            {isSaved ? (<><CheckCircle size={16}/><span>‰øùÂ≠ò</span></>) : (<><Check size={16}/><span>„Åë„Å£„Å¶„ÅÑ</span></>)}
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      };

      // =========================
      // STATSÔºàÁõÆÊ®ôÂÖ•ÂäõÔºö„Éâ„É©„Éï„Éà‚Üí‰øùÂ≠òÊôÇÂèçÊò†Ôºâ
      // =========================
      const StatsView = () => {
        return (
          <div className="space-y-4 animate-fadeInUp">
            <div className="bg-white rounded-3xl p-5 shadow-md border-4 border-sky-100 relative overflow-hidden">
              <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                <Trophy size={220}/>
              </div>

              <div className="relative z-10 flex items-center justify-between gap-2 flex-wrap">
                <div className="flex items-center gap-2">
                  <Trophy className="text-orange-500" size={22}/>
                  <div className="text-lg font-black text-slate-800">„Åî„ÅÜ„Åë„ÅÑ „Å® „ÇÇ„Åè„Å≤„Çá„ÅÜ</div>
                </div>

                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={()=>{
                      playClick();
                      // ‚òÖÈñã„ÅÑ„ÅüÁû¨Èñì„Å´„Éâ„É©„Éï„Éà„Å∏„Ç≥„Éî„ÉºÔºàÂÖ•ÂäõÈÄî‰∏≠„Åß goals „ÇíËß¶„Çâ„Å™„ÅÑÔºâ
                      const draft = {};
                      displayTricks.forEach(t => { draft[t.id] = String(goals[t.id] ?? ""); });
                      setGoalDraft(draft);
                      setGoalModalOpen(true);
                    }}
                    className="px-4 py-2 rounded-full bg-sky-100 hover:bg-sky-200 border border-sky-200 text-sky-700 font-black text-xs flex items-center gap-2 shadow-sm active:scale-95"
                  >
                    <Settings size={16}/> ÁõÆÊ®ô„ÅÆË®≠ÂÆö
                  </button>
                  <button
                    type="button"
                    onClick={()=>{ playClick(); setImportModalOpen(true); }}
                    className="px-4 py-2 rounded-full bg-white hover:bg-slate-50 border border-slate-200 text-slate-700 font-black text-xs flex items-center gap-2 shadow-sm active:scale-95"
                  >
                    <Upload size={16}/> Âæ©ÂÖÉÔºàË≤º„Çä‰ªò„ÅëÔºâ
                  </button>
                  <button
                    type="button"
                    onClick={handleCopyAllRecordsTSV}
                    className="px-4 py-2 rounded-full bg-orange-100 hover:bg-orange-200 border border-orange-200 text-orange-700 font-black text-xs flex items-center gap-2 shadow-sm active:scale-95"
                  >
                    <Copy size={16}/> ÂÖ®ÈÉ®„Ç≥„Éî„Éº
                  </button>
                </div>
              </div>

              <div className="relative z-10 mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
                <div className="flex items-center justify-between">
                  <div className="font-black text-slate-600">„Åú„Çì„Å∂„ÅÆ „Åî„ÅÜ„Åë„ÅÑ</div>
                  <div className="text-3xl font-black text-slate-900">{totalAll}</div>
                </div>
                <div className="text-[11px] font-bold text-slate-500 mt-1">
                  „Åü„Åè„Åï„ÇìÁ∑¥Áøí„Åô„Çã„Å®„ÄÅ„Å©„Çì„Å©„ÇìÊï∞Â≠ó„Åå„Åü„Åæ„Çã„ÇàÔºÅ
                </div>
              </div>

              <div className="relative z-10 mt-4 space-y-3">
                {displayTricks.map(t => {
                  const total = Number(totalsByTrick[t.id] || 0);
                  const goal = Number(goals[t.id] || 0);
                  const pct = goal > 0 ? Math.min(100, Math.round((total/goal)*100)) : 0;
                  const done = goal > 0 && total >= goal;

                  return (
                    <div key={t.id} className="bg-white rounded-2xl border border-slate-200 p-3 shadow-sm">
                      <div className="flex items-center justify-between gap-3 flex-wrap">
                        <div className="flex items-center gap-3 min-w-0">
                          <div className={`w-11 h-11 rounded-2xl flex items-center justify-center font-black shadow-sm ${t.color}`}>
                            {t.label.substring(0,1)}
                          </div>
                          <div className="min-w-0">
                            <div className="font-black text-slate-800 truncate whitespace-nowrap max-w-[240px]">{t.label}</div>
                            <div className="text-[11px] font-bold text-slate-500">
                              ÂêàË®àÔºö<span className="text-slate-800 font-black">{total}</span>„ÄÄ
                              ÁõÆÊ®ôÔºö<span className="text-orange-700 font-black">{goal || "Êú™Ë®≠ÂÆö"}</span>
                              {done && <span className="ml-2 inline-flex items-center gap-1 text-emerald-600 font-black"><CheckCircle size={14}/> ÈÅîÊàêÔºÅ</span>}
                            </div>
                          </div>
                        </div>

                        <div className="text-right">
                          <div className="text-xl font-black text-slate-900">{pct}<span className="text-xs">%</span></div>
                          <div className="text-[11px] font-bold text-slate-400">„ÇÇ„Åè„Å≤„Çá„ÅÜ„Åæ„Åß</div>
                        </div>
                      </div>

                      <div className="mt-3">
                        <div className="w-full h-3 rounded-full bg-slate-100 border border-slate-200 overflow-hidden">
                          <div className="h-full bg-gradient-to-r from-orange-400 to-pink-500" style={{width: `${pct}%`}}></div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm">
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 rounded-2xl bg-orange-100 text-orange-700 flex items-center justify-center border border-orange-200">
                  <Target size={18}/>
                </div>
                <div>
                  <div className="font-black text-slate-700">„Éù„Ç§„É≥„Éà</div>
                  <div className="text-sm text-slate-500 font-bold leading-relaxed">
                    ÁõÆÊ®ô„ÇíÈÅîÊàê„Åô„Çã„Å®„ÄÅ<span className="text-orange-600 font-black">Ê¨°„ÅÆÁõÆÊ®ôÔºà+20%Ôºâ</span>„ÇíÊèêÊ°à„Åô„Çã„Çà„ÄÇ
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // =========================
      // CERT
      // =========================
      const CertView = () => (
        <div className="space-y-6 animate-fadeInUp">
          {user.grade <= 2 && (
            <div className="bg-white rounded-3xl p-6 shadow-lg border-4 border-pink-200 relative overflow-hidden text-center">
              <div className="absolute top-0 left-0 w-full h-4 bg-pink-200"></div>
              <div className="mt-3 mb-2">
                <div className="inline-block p-3 bg-pink-100 rounded-full text-pink-500 mb-2">
                  <Star size={32} fill="currentColor"/>
                </div>
                <div className="text-2xl font-black text-pink-500">„Å´„Çì„Å¶„ÅÑ„Åó„Çá„ÅÜ</div>
              </div>
              <div className="text-lg font-black text-slate-700 mb-4">
                {user.grade}„Å≠„Çì {user.classVal}„Åè„Åø {user.number}„Å∞„Çì<br/>
                <span className="text-2xl border-b-2 border-pink-300 px-2">
                  {user.name ? user.name : "Ôºà„Å™„Åæ„ÅàÔºâ"}
                </span> „Åï„Çì
              </div>
              <div className="bg-pink-50 rounded-2xl p-4 mb-4 border border-pink-200">
                <div className="text-sm font-black text-pink-400 mb-1">„ÅÇ„Å™„Åü„ÅØ</div>
                <div className="text-5xl font-black text-pink-600 tracking-tight my-2">
                  {currentBestLevel ? currentBestLevel.name : "„Åå„Çì„Å∞„Çä‰∏≠"}
                </div>
                <div className="text-sm font-black text-pink-400">„Å´„Åî„ÅÜ„Åã„Åè„Åó„Åæ„Åó„ÅüÔºÅ</div>
              </div>
              <div className="text-xs font-black text-slate-400">„Çà„Åè „Åå„Çì„Å∞„Çä„Åæ„Åó„Åü</div>
              <div className="absolute -bottom-6 -right-6 w-24 h-24 bg-yellow-200 rounded-full opacity-50"></div>
              <div className="absolute -bottom-6 -left-6 w-20 h-20 bg-blue-200 rounded-full opacity-50"></div>
            </div>
          )}

          {(user.grade === 3 || user.grade === 4) && (
            <div className="bg-white rounded-3xl p-6 shadow-lg border border-sky-200 text-center">
              <div className="border-4 border-double border-sky-100 p-6 rounded-2xl">
                <Award size={48} className="mx-auto text-sky-500"/>
                <div className="text-3xl font-black text-sky-700 mt-2">Ë™çÂÆöË®º</div>

                <div className="mt-4 text-left bg-sky-50/70 p-4 rounded-2xl border border-sky-100 text-slate-700">
                  <div className="font-black mb-1">Á¨¨ {user.grade} Â≠¶Âπ¥ {user.classVal} ÁµÑ {user.number} Áï™</div>
                  <div className="text-2xl font-black border-b border-sky-300 pb-1 mb-3 inline-block min-w-[200px] text-center">
                    {user.name ? user.name : "ÔºàÂêçÂâçÔºâ"} ÊÆø
                  </div>
                  <div className="text-sm font-bold leading-relaxed">
                    „ÅÇ„Å™„Åü„ÅØ„ÄÅ„Å™„Çè„Å®„Å≥Ê§úÂÆö„Å´„Åä„ÅÑ„Å¶<br/>
                    È†≠Êõ∏„ÅÆÊàêÁ∏æ„ÇíÂèé„ÇÅ„Çâ„Çå„Åæ„Åó„Åü„ÄÇ<br/>
                    „Çà„Å£„Å¶„Åì„Åì„Å´„Åì„Çå„ÇíË®º„Åó„Åæ„Åô„ÄÇ
                  </div>
                </div>

                <div className="mt-5">
                  <div className="text-sm font-black text-sky-500">Ë™çÂÆöÁ¥ö</div>
                  <div className="text-4xl font-black text-sky-800 border-2 border-sky-600 inline-block px-8 py-2 rounded-2xl mt-2 bg-white shadow-sm">
                    {currentBestLevel ? currentBestLevel.name : "‚Äï"}
                  </div>
                </div>
              </div>
            </div>
          )}

          {user.grade >= 5 && (
            <div className="bg-slate-50 rounded-2xl p-6 shadow-xl border-t-8 relative text-center" style={{borderColor:"#d4af37"}}>
              <div className="mb-6 mt-2">
                <div className="text-xs tracking-[0.2em] text-slate-500 uppercase font-black mb-1">Certificate of Achievement</div>
                <div className="text-4xl font-black text-slate-800 border-b-2 border-slate-300 inline-block pb-2 px-4">Ë®òÈå≤Ë®º</div>
              </div>

              <div className="flex justify-between items-end mb-6 px-2">
                <div className="text-left">
                  <div className="text-sm font-bold text-slate-500">Name</div>
                  <div className="text-xl font-black text-slate-800">{user.name || "__________"}</div>
                </div>
                <div className="text-right">
                  <div className="text-sm font-bold text-slate-500">Grade</div>
                  <div className="text-xl font-black text-slate-800">{user.grade}-{user.classVal} ({user.number})</div>
                </div>
              </div>

              <div className="bg-white border border-slate-200 p-8 rounded-2xl shadow-inner mb-4">
                <div className="text-sm font-black text-slate-500 mb-2">Achieved Level</div>
                <div className="text-5xl font-black" style={{color:"#d4af37", textShadow:"1px 1px 0 rgba(0,0,0,0.08)"}}>
                  {currentBestLevel ? currentBestLevel.name : "Unranked"}
                </div>
              </div>

              <div className="text-left text-xs text-slate-400 font-bold mt-6 border-t border-slate-200 pt-2">
                Â§ßÂ§öÂñúÁî∫Á´ãÂ§ßÂ§öÂñúÂ∞èÂ≠¶Ê†°
              </div>
            </div>
          )}

          <div className="bg-white rounded-3xl p-4 shadow-sm border border-slate-100">
            <div className="font-black text-slate-700 flex items-center gap-2 mb-3">
              <Target size={18} className="text-red-500"/>
              {goalTitle}
            </div>

            {nextLevels.length ? (
              <div className="space-y-2">
                {nextLevels.map(lvl => (
                  <div key={lvl.level} className="p-3 rounded-2xl border border-slate-100 bg-white text-slate-600 text-xs flex items-center justify-between">
                    <div className="flex items-center gap-3 flex-wrap">
                      <div className="font-black text-sm text-slate-500">{lvl.name}</div>
                      <div className="flex flex-wrap gap-1">
                        {Object.entries(lvl.reqs).map(([trickId, cnt]) => {
                          const trick = displayTricks.find(t => t.id === trickId);
                          if (!trick || !cnt) return null;
                          return (
                            <span key={trickId} className="px-2 py-1 rounded-xl border bg-slate-50 border-slate-200 font-bold">
                              {trick.label}: {cnt}Âõû
                            </span>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center p-6 bg-yellow-50 rounded-2xl border border-yellow-200">
                <Trophy size={44} className="mx-auto text-yellow-500 mb-2"/>
                <div className="text-lg font-black text-yellow-700">„Åô„Åπ„Å¶„ÅÆÁ¥ö„Çí„ÇØ„É™„Ç¢ÔºÅ</div>
                <div className="text-xs font-bold text-yellow-700">„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ</div>
              </div>
            )}
          </div>
        </div>
      );

      // =========================
      // HISTORYÔºà‰∏ÄË¶ß„ÅÆÊó•‰ªò„ÇØ„É™„ÉÉ„ÇØ‚Üí„Ç´„É¨„É≥„ÉÄ„Éº„ÅßÊó•‰ªòÂ§âÊõ¥Ôºâ
      // =========================
      const HistoryView = () => {
        const dates = Object.keys(dailyRecords).sort((a,b)=> new Date(a)-new Date(b));

        const streak = (() => {
          const now = new Date();
          const today = todayKeyLocal();
          const doneToday = !!history[today];
          let count = 0;

          const isWeekendOrHoliday = (d) => d.getDay() === 0 || d.getDay() === 6 || isJapaneseHoliday(d);

          if (doneToday){
            count = 1;
            const d = new Date(now);
            while(true){
              d.setDate(d.getDate()-1);
              const k = toLocalKey(d);
              if (history[k]) { count++; continue; }
              if (!isWeekendOrHoliday(d)) break;
            }
          } else {
            const d = new Date(now);
            d.setDate(d.getDate()-1);
            while(true){
              const k = toLocalKey(d);
              if (history[k]) { count++; d.setDate(d.getDate()-1); continue; }
              if (!isWeekendOrHoliday(d)) break;
              d.setDate(d.getDate()-1);
            }
          }
          return {count, doneToday};
        })();

        return (
          <div className="space-y-4 animate-fadeInUp">
            <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
              <div className="flex items-center justify-between flex-wrap gap-2">
                <div className="flex items-center gap-2">
                  <Calendar className="text-emerald-500" size={22}/>
                  <div className="text-lg font-black text-slate-800">„Åå„Çì„Å∞„Çä</div>
                </div>

                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={()=>{ playClick(); setHistoryView("calendar"); }}
                    className={`px-4 py-2 rounded-full font-black text-xs border transition active:scale-95 ${
                      historyView==="calendar" ? "bg-emerald-500 text-white border-emerald-500" : "bg-white text-slate-600 border-slate-200 hover:bg-slate-50"
                    }`}
                  >
                    „Ç´„É¨„É≥„ÉÄ„Éº
                  </button>
                  <button
                    type="button"
                    onClick={()=>{ playClick(); setHistoryView("table"); }}
                    className={`px-4 py-2 rounded-full font-black text-xs border transition active:scale-95 ${
                      historyView==="table" ? "bg-emerald-500 text-white border-emerald-500" : "bg-white text-slate-600 border-slate-200 hover:bg-slate-50"
                    }`}
                  >
                    ‰∏ÄË¶ß
                  </button>
                </div>
              </div>

              <div className="mt-4 bg-orange-100 border-2 border-orange-200 rounded-2xl p-4 text-center">
                <div className="flex items-center justify-center gap-2 mb-1">
                  <Flame className="text-orange-600" size={22}/>
                  <div className="text-lg font-black text-orange-700">„Çå„Çì„Åû„ÅèË®òÈå≤</div>
                  <Flame className="text-orange-600" size={22}/>
                </div>
                <div className="text-4xl font-black text-orange-600">
                  {streak.count}<span className="text-base">Êó•</span>
                </div>
                <div className="text-xs font-black text-orange-500 mt-1">
                  {streak.count>0 ? (streak.doneToday ? "„Åô„Åî„ÅÑÔºÅ „Åç„Çá„ÅÜ„ÇÇ „Åü„Å£„Åõ„ÅÑÔºÅ" : "„Åç„ÅÆ„ÅÜ„Åæ„Åß „Å§„Å•„ÅÑ„Å¶„Çã„ÇàÔºÅ") : "„Åç„Çá„ÅÜ„Åã„Çâ „ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ"}
                </div>
              </div>

              {historyView === "calendar" ? (
                <div className="mt-5">
                  <div className="grid grid-cols-7 gap-2 max-w-sm mx-auto">
                    {[...Array(14)].map((_, i) => {
                      const d = new Date();
                      d.setDate(d.getDate() - (13 - i));
                      const k = toLocalKey(d);
                      const has = !!history[k];
                      const isToday = (k === todayKeyLocal());
                      return (
                        <div key={i} className="flex flex-col items-center gap-1">
                          <div className="text-[10px] font-bold text-slate-400">{d.getMonth()+1}/{d.getDate()}</div>
                          <div className={`w-11 h-11 rounded-2xl border-2 flex items-center justify-center transition ${
                            has ? "bg-emerald-100 border-emerald-500 text-emerald-700 scale-[1.03]" : "bg-slate-50 border-slate-100 text-slate-300"
                          } ${isToday ? "ring-2 ring-offset-2 ring-sky-300" : ""}`}>
                            {has ? <Medal size={20} fill="currentColor"/> : <div className="w-2 h-2 rounded-full bg-slate-200"></div>}
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  <div className="mt-5 bg-emerald-50 p-4 rounded-2xl border border-emerald-100 text-left">
                    <div className="flex items-center gap-3 mb-2">
                      <User className="text-emerald-600" size={20}/>
                      <div className="font-black text-emerald-800">{user.name || "ÂêçÁÑ°„Åó"} „Åï„Çì„ÅÆ„Åç„Çç„Åè</div>
                    </div>
                    <div className="text-xs font-bold text-emerald-700">
                      {user.isRegistered ? "Ë®òÈå≤‰∏≠" : "Êú™ÁôªÈå≤"}
                    </div>
                    <div className="mt-3 flex gap-2 flex-wrap">
                      <button
                        type="button"
                        onClick={()=>{ playClick(); setActiveTab("input"); }}
                        className="px-4 py-2 rounded-2xl bg-white border border-emerald-200 text-emerald-800 font-black text-xs active:scale-95"
                      >
                        „Åç„Çç„Åè „Çí „Å§„Åë„Çã
                      </button>
                      <button
                        type="button"
                        onClick={()=>{ playClick(); setActiveTab("stats"); }}
                        className="px-4 py-2 rounded-2xl bg-white border border-orange-200 text-orange-700 font-black text-xs active:scale-95"
                      >
                        „Åî„ÅÜ„Åë„ÅÑ „Çí „Åø„Çã
                      </button>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="mt-5">
                  <div className="flex items-center justify-between flex-wrap gap-2 mb-3">
                    <div className="font-black text-slate-700 flex items-center gap-2">
                      <List size={18}/> „Åç„Çç„Åè‰∏ÄË¶ßÔºàÂè≥„Å´„Çπ„ÇØ„É≠„Éº„É´Ôºâ
                    </div>
                    <div className="flex gap-2">
                      <button
                        type="button"
                        onClick={handleCopyAllRecordsTSV}
                        className="px-4 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200 border border-slate-200 text-slate-700 font-black text-xs flex items-center gap-2 active:scale-95"
                      >
                        <Copy size={16}/> ÂÖ®ÈÉ®„Ç≥„Éî„Éº
                      </button>
                      <button
                        type="button"
                        onClick={()=>{ playClick(); setImportModalOpen(true); }}
                        className="px-4 py-2 rounded-2xl bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 text-emerald-800 font-black text-xs flex items-center gap-2 active:scale-95"
                      >
                        <Upload size={16}/> Âæ©ÂÖÉ
                      </button>
                    </div>
                  </div>

                  <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div className="overflow-x-auto custom-scrollbar">
                      <table className="w-full text-sm">
                        <thead className="bg-slate-100">
                          <tr>
                            <th className="sticky-corner p-3 text-center font-black min-w-[120px]">Êó•‰ªò</th>
                            {displayTricks.map(t => (
                              <th key={t.id} className="p-3 font-black text-slate-700 min-w-[110px] text-center">
                                {t.label}
                              </th>
                            ))}
                            <th className="p-3 font-black text-slate-700 min-w-[140px] text-center">Êìç‰Ωú</th>
                          </tr>
                        </thead>

                        <tbody>
                          {dates.length ? dates.map(dk => {
                            const rec = dailyRecords[dk] || {};
                            return (
                              <tr key={dk} className="border-b border-slate-100 hover:bg-slate-50">
                                <td className="sticky-col p-3 font-black text-slate-700 min-w-[120px]">
                                  <button
                                    type="button"
                                    onClick={()=>{ playClick(); setDateMoveModal({fromKey: dk}); }}
                                    className="underline decoration-slate-200 hover:decoration-slate-400"
                                    title="Êó•‰ªò„ÇíÂ§âÊõ¥"
                                  >
                                    {dk}
                                  </button>
                                </td>
                                {displayTricks.map(t => (
                                  <td key={t.id} className="p-3 text-center font-black text-slate-700">
                                    {Number(rec[t.id] || 0)}
                                  </td>
                                ))}
                                <td className="p-3 text-center">
                                  <div className="flex gap-2 justify-center flex-wrap">
                                    <button
                                      type="button"
                                      onClick={()=>{ playClick(); setTargetDate(dk); setActiveTab("input"); }}
                                      className="px-3 py-2 rounded-xl bg-sky-50 hover:bg-sky-100 border border-sky-200 text-sky-700 font-black text-xs active:scale-95"
                                    >
                                      Á∑®ÈõÜ
                                    </button>
                                    <button
                                      type="button"
                                      onClick={()=>{ setDeleteModal({type:"date", dateKey: dk}); }}
                                      className="px-3 py-2 rounded-xl bg-red-50 hover:bg-red-100 border border-red-200 text-red-700 font-black text-xs active:scale-95"
                                    >
                                      ÂâäÈô§
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            );
                          }) : (
                            <tr>
                              <td colSpan={displayTricks.length + 2} className="p-6 text-center text-slate-400 font-black">
                                „Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                              </td>
                            </tr>
                          )}
                        </tbody>

                        {dates.length ? (
                          <tfoot>
                            <tr className="bg-slate-50 border-t border-slate-200">
                              <td className="sticky-col p-3 font-black text-slate-700">ÂêàË®à</td>
                              {displayTricks.map(t => (
                                <td key={t.id} className="p-3 text-center font-black text-slate-700">
                                  {Number(totalsByTrick[t.id] || 0)}
                                </td>
                              ))}
                              <td className="p-3 text-center text-xs font-black text-slate-400">‚Äî</td>
                            </tr>
                          </tfoot>
                        ) : null}
                      </table>
                    </div>
                  </div>

                  <div className="mt-3 text-center text-xs font-bold text-slate-400">
                    ‚Äª „Ç≥„Éî„Éº„Åó„Åü„Çâ„ÄÅ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åß„ÄåË≤º„Çä‰ªò„Åë„Äç„Åß„Åç„Çã„Çà
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      // =========================
      // ModalsÔºà‚òÖGoalÔºö„Éâ„É©„Éï„ÉàÂÖ•ÂäõÔºâ
      // =========================
      const GoalModal = () => (
        <ModalShell open={goalModalOpen} onClose={()=>setGoalModalOpen(false)} playClick={playClick}>
          <div className="bg-white rounded-3xl p-6 border-4 border-sky-200 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col">
            <div className="flex items-center justify-between">
              <div className="text-xl font-black text-sky-700 flex items-center gap-2">
                <Settings size={20}/> ÁõÆÊ®ô„ÅÆË®≠ÂÆö
              </div>
            </div>
            <div className="text-xs font-bold text-slate-500 mt-1">
              ÁõÆÊ®ô„ÅØ„ÄåÂêàË®à„Äç„Å´ÂØæ„Åó„Å¶„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Åæ„ÅôÔºàÈÅîÊàê„Åô„Çã„Å® +20% „ÇíÊèêÊ°àÔºâ
            </div>

            <div className="mt-4 space-y-3 overflow-y-auto pr-1 custom-scrollbar flex-1">
              {displayTricks.map(t => (
                <div key={t.id} className="p-3 rounded-2xl border border-slate-200 bg-slate-50">
                  <div className="flex items-center justify-between gap-2">
                    <div className="flex items-center gap-3 min-w-0">
                      <div className={`w-10 h-10 rounded-2xl flex items-center justify-center font-black ${t.color}`}>
                        {t.label.substring(0,1)}
                      </div>
                      <div className="font-black text-slate-800 truncate whitespace-nowrap max-w-[220px]">{t.label}</div>
                    </div>

                    <div className="flex items-center gap-2">
                      <div className="text-xs font-black text-slate-500">ÁõÆÊ®ô</div>
                      <input
                        type="text"
                        inputMode="numeric"
                        pattern="\d*"
                        value={goalDraft[t.id] ?? ""}
                        onKeyDown={(e)=>{ if(e.key==="Enter"){ e.preventDefault(); e.currentTarget.blur(); } }}
                        onChange={(e)=>{
                          const raw = normalizeDigits(e.target.value);
                          setGoalDraft(prev => ({...prev, [t.id]: raw}));
                        }}
                        className="w-28 text-center font-black text-lg rounded-2xl border border-slate-200 bg-white p-2 focus:outline-none focus:ring-2 focus:ring-sky-400 select-text"
                        placeholder="0"
                      />
                    </div>
                  </div>
                  <div className="mt-2 text-[11px] font-bold text-slate-500">
                    ÁèæÂú®„ÅÆÂêàË®àÔºö<span className="font-black text-slate-800">{Number(totalsByTrick[t.id] || 0)}</span>
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-4 flex gap-2">
              <button
                type="button"
                onClick={()=>{ playClick(); setGoalModalOpen(false); }}
                className="flex-1 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-black"
              >
                Èñâ„Åò„Çã
              </button>
              <button
                type="button"
                onClick={()=>{
                  playSuccess();
                  const next = {...goals};
                  displayTricks.forEach(t=>{
                    const v = parseInt(goalDraft[t.id] ?? "", 10);
                    next[t.id] = isNaN(v) ? 0 : v;
                  });
                  setGoals(next);
                  setGoalModalOpen(false);
                }}
                className="flex-1 py-3 rounded-2xl bg-sky-600 hover:bg-sky-500 text-white font-black shadow"
              >
                ‰øùÂ≠ò
              </button>
            </div>
          </div>
        </ModalShell>
      );

      const GoalUpdateModal = () => {
        const data = goalUpdateModal;
        if (!data) return null;
        const trick = displayTricks.find(t => t.id === data.trickId);
        return (
          <ModalShell open={!!goalUpdateModal} onClose={()=>setGoalUpdateModal(null)} playClick={playClick}>
            <div className="bg-white rounded-3xl p-6 border-4 border-yellow-300 shadow-2xl overflow-hidden relative">
              <div className="absolute inset-0 bg-confetti opacity-30 pointer-events-none"></div>
              <div className="relative z-10 text-center">
                <div className="text-6xl mb-2">üéä</div>
                <div className="text-2xl font-black text-orange-600">ÁõÆÊ®ôÈÅîÊàêÔºÅ</div>
                <div className="text-sm font-black text-slate-700 mt-1">{trick ? trick.label : "„Åì„ÅÆÊäÄ"}</div>

                <div className="mt-4 bg-white rounded-2xl border border-orange-200 p-4 shadow-sm">
                  <div className="text-xs font-black text-slate-500">Ê¨°„ÅÆÁõÆÊ®ô</div>
                  <div className="mt-2 flex items-center justify-center gap-2 text-2xl font-black">
                    <span className="text-slate-400 line-through">{data.oldGoal}</span>
                    <span className="text-slate-400">‚Üí</span>
                    <span className="text-orange-600 text-4xl">{data.newGoal}</span>
                    <span className="text-sm text-orange-600">Âõû</span>
                  </div>
                  <div className="text-xs font-black text-orange-400 mt-1">(20% UP!)</div>
                </div>

                <div className="mt-4 text-sm font-black text-slate-600">„Åì„ÅÆÁõÆÊ®ô„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü</div>

                <div className="mt-4 flex gap-3">
                  <button
                    type="button"
                    onClick={()=>{ playClick(); setGoalUpdateModal(null); }}
                    className="flex-1 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-black"
                  >
                    „ÅÑ„ÅÑ„Åà
                  </button>
                  <button
                    type="button"
                    onClick={()=>{
                      playSuccess();
                      setGoals(prev => ({...prev, [data.trickId]: data.newGoal}));
                      setGoalUpdateModal(null);
                    }}
                    className="flex-1 py-3 rounded-2xl bg-orange-500 hover:bg-orange-600 text-white font-black shadow"
                  >
                    „ÅØ„ÅÑ
                  </button>
                </div>
              </div>
            </div>
          </ModalShell>
        );
      };

      const ImportModal = () => (
        <ModalShell open={importModalOpen} onClose={()=>setImportModalOpen(false)} playClick={playClick}>
          <div className="bg-white rounded-3xl p-6 border-4 border-emerald-300 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col">
            <div className="text-xl font-black text-emerald-700 text-center">üì• Ë®òÈå≤„ÇíÂæ©ÂÖÉÔºàË≤º„Çä‰ªò„ÅëÔºâ</div>
            <div className="text-xs font-bold text-slate-500 mt-2">
              „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åã„Çâ„Ç≥„Éî„Éº„Åó„Åü„Éá„Éº„Çø„Çí„ÄÅ„Åù„ÅÆ„Åæ„ÅæË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºà1Ë°åÁõÆ„Å´„ÄåÊó•‰ªò„Äç„ÄåÊäÄÂêç„ÄçÔºâ
            </div>

            <textarea
              value={importText}
              onChange={(e)=>setImportText(e.target.value)}
              className="mt-3 w-full h-48 rounded-2xl border-2 border-slate-200 bg-slate-50 p-3 text-xs font-mono focus:outline-none focus:ring-2 focus:ring-emerald-400 resize-none custom-scrollbar select-text"
              placeholder={"Êó•‰ªò\t„Åæ„Åà„Å®„Å≥\t„ÅÜ„Åó„Çç„Å®„Å≥...\n2026-01-14\t10\t5\t...\n..."}
            />

            <div className="mt-4 flex gap-2">
              <button
                type="button"
                onClick={()=>{ playClick(); setImportModalOpen(false); }}
                className="flex-1 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-black"
              >
                „Ç≠„É£„É≥„Çª„É´
              </button>
              <button
                type="button"
                onClick={()=>{ playClick(); executeImportTSV(); }}
                className="flex-1 py-3 rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white font-black shadow"
              >
                Ë™≠„ÅøËæº„ÇÄ
              </button>
            </div>
          </div>
        </ModalShell>
      );

      const DeleteModal = () => {
        if (!deleteModal) return null;
        const type = deleteModal.type;
        const title =
          type==="date" ? "„Åì„ÅÆÊó•„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü" :
          type==="hard" ? "ÂÆåÂÖ®„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü" :
          "Ë®òÈå≤„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü";
        const msg =
          type==="date" ? "„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ" :
          type==="hard" ? "ÂêçÂâç„ÉªË®òÈå≤„ÉªÁõÆÊ®ô„ÉªÊ§úÂÆöË°®ÔºàÂÖàÁîüË®≠ÂÆöÔºâ„ÇÇÂê´„ÇÅ„ÄÅ„Åô„Åπ„Å¶Ê∂à„Åà„Åæ„Åô„ÄÇ" :
          "Ë®òÈå≤Ôºà„Åå„Çì„Å∞„Çä„Éª„Éô„Çπ„Éà„ÉªÂ±•Ê≠¥„ÉªÁõÆÊ®ôÈÅîÊàêÂ±•Ê≠¥Ôºâ„ÇíÊ∂à„Åó„Åæ„Åô„ÄÇÊ§úÂÆöË°®„ÅØÊÆã„Çä„Åæ„Åô„ÄÇ";

        const yes = () => {
          if (type==="date") deleteDateRow(deleteModal.dateKey);
          if (type==="soft") softResetRecordsOnly();
          if (type==="hard") hardResetAll();
          setDeleteModal(null);
        };

        return (
          <ModalShell open={!!deleteModal} onClose={()=>setDeleteModal(null)} playClick={playClick}>
            <div className="bg-white rounded-3xl p-6 border-4 border-slate-200 shadow-2xl">
              <div className="text-lg font-black text-slate-800 text-center">{title}</div>
              <div className="text-sm font-bold text-slate-500 text-center mt-2">{msg}</div>

              {type==="date" && (
                <div className="text-center mt-3 text-xs font-black text-slate-500">
                  ÂØæË±°Ôºö<span className="text-slate-800">{deleteModal.dateKey}</span>
                </div>
              )}

              <div className="mt-5 flex gap-3">
                <button
                  type="button"
                  onClick={()=>{ playClick(); setDeleteModal(null); }}
                  className="flex-1 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-black"
                >
                  „Ç≠„É£„É≥„Çª„É´
                </button>
                <button
                  type="button"
                  onClick={()=>{ playClick(); yes(); }}
                  className={`flex-1 py-3 rounded-2xl text-white font-black shadow ${
                    type==="hard" || type==="date" ? "bg-red-500 hover:bg-red-600" : "bg-orange-500 hover:bg-orange-600"
                  }`}
                >
                  Ê∂à„Åô
                </button>
              </div>
            </div>
          </ModalShell>
        );
      };

      // =========================
      // Main layoutÔºà‚òÖ view/ modal „Çí„Äå„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å®„Åó„Å¶„Äç‰Ωø„Çè„Å™„ÅÑÔºù„ÉÅ„Ç´„ÉÅ„Ç´Ëß£Ê∂àÔºâ
      // =========================
      return (
        <div className="min-h-screen">
          <canvas ref={confetti.canvasRef} className="fixed inset-0 z-[9998] pointer-events-none"></canvas>

          {Header()}

          <main className="max-w-2xl mx-auto px-4 py-5 space-y-5 min-h-[80vh]">
            {activeTab === "home" && HomeView()}
            {activeTab === "input" && InputView()}
            {activeTab === "stats" && StatsView()}
            {activeTab === "cert" && CertView()}
            {activeTab === "history" && HistoryView()}
          </main>

          <nav className="fixed bottom-0 left-0 right-0 z-50 bg-white/90 backdrop-blur border-t border-slate-200 shadow-[0_-8px_16px_-12px_rgba(0,0,0,0.25)]" style={{paddingBottom:"env(safe-area-inset-bottom, 0px)"}}>
            <div className="max-w-2xl mx-auto px-3 py-2 flex items-center gap-2">
              <NavButton
                label="Ë°®Á¥ô"
                icon={Home}
                active={activeTab==="home"}
                onClick={()=>{ playClick(); setActiveTab("home"); }}
              />
              <NavButton
                label="„Åç„Çç„Åè"
                icon={RefreshCw}
                active={activeTab==="input"}
                onClick={()=>{ playClick(); setActiveTab("input"); }}
                badge={targetDate === todayKeyLocal() ? "‰ªäÊó•" : ""}
              />
              <NavButton
                label="„Åî„ÅÜ„Åë„ÅÑ"
                icon={Trophy}
                active={activeTab==="stats"}
                onClick={()=>{ playClick(); setActiveTab("stats"); }}
              />
              <NavButton
                label="Ë™çÂÆö"
                icon={Award}
                active={activeTab==="cert"}
                onClick={()=>{ playClick(); setActiveTab("cert"); }}
              />
              <NavButton
                label="„Åå„Çì„Å∞„Çä"
                icon={Calendar}
                active={activeTab==="history"}
                onClick={()=>{ playClick(); setActiveTab("history"); }}
              />
            </div>
          </nav>

          {copyToast && (
            <div className="fixed top-16 left-1/2 -translate-x-1/2 z-[9999] animate-popIn">
              <div className="bg-slate-900 text-white px-4 py-2 rounded-full shadow-lg text-xs font-black flex items-center gap-2">
                <CheckCircle size={16}/> OKÔºÅ
              </div>
            </div>
          )}

          {GoalModal()}
          {GoalUpdateModal()}
          {ImportModal()}
          {DeleteModal()}

          <CalendarMoveModal
            open={!!dateMoveModal}
            fromKey={dateMoveModal?.fromKey}
            initialKey={dateMoveModal?.fromKey || todayKeyLocal()}
            playClick={playClick}
            onClose={()=>setDateMoveModal(null)}
            onConfirm={(newKey)=>{
              const from = dateMoveModal?.fromKey;
              setDateMoveModal(null);
              moveDateKey(from, newKey);
            }}
          />

          <footer className="hidden sm:block text-center text-xs font-bold text-slate-400 pb-24">
            ¬©2026 Takayuki WAYAMA „Å™„Çè„Å®„Å≥Ê§úÂÆö„Ç´„Éº„Éâ
          </footer>
        </div>
      );
    }

    const root = createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>


